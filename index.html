<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>じゃんけんAI (Gemini搭載)</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --bg-color: #f4f7f9;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --card-shadow: rgba(0, 0, 0, 0.05);
            --border-color: #e3e8ee;
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --warning-color: #f39c12;
            --warning-hover: #e67e22;
            --disabled-bg: #bdc3c7;
            --disabled-text: #7f8c8d;
            --secondary-text: #7f8c8d;
            --accent1-color: #2980b9;
            --accent2-color: #c0392b;
            --accent3-color: #7f8c8d;
            --win-glow: rgba(46, 204, 113, 0.3);
            --lose-glow: rgba(231, 76, 60, 0.3);
            --draw-glow: rgba(149, 165, 166, 0.3);
            --nav-bg: #ffffff;
            --nav-icon-color: #7f8c8d;
            --nav-icon-active-color: var(--primary-color);
            --nav-width-collapsed: 60px;
            --nav-width-expanded: 220px;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a2e;
                --text-color: #e0e0e0;
                --card-bg: #242444;
                --card-shadow: rgba(0, 0, 0, 0.2);
                --border-color: #3a3a5e;
                --primary-color: #4a90e2;
                --primary-hover: #63a4ff;
                --danger-color: #e94b3c;
                --danger-hover: #ff6b5a;
                --warning-color: #f2994a;
                --warning-hover: #f5b784;
                --disabled-bg: #4f4f6b;
                --disabled-text: #a0a0b8;
                --secondary-text: #a0a0b8;
                --accent1-color: #4a90e2;
                --accent2-color: #e94b3c;
                --accent3-color: #a0a0b8;
                --win-glow: rgba(80, 227, 194, 0.2);
                --lose-glow: rgba(233, 75, 60, 0.2);
                --draw-glow: rgba(160, 160, 184, 0.2);
                --nav-bg: #1e1e3f;
                --nav-icon-color: #a0a0b8;
                --nav-icon-active-color: var(--primary-color);
            }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes dash { 0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; } 50% { stroke-dasharray: 90, 150; stroke-dashoffset: -35; } 100% { stroke-dasharray: 90, 150; stroke-dashoffset: -124; } }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; }
        .app-container { display: flex; }

        #main-nav { position: fixed; z-index: 100; background-color: var(--nav-bg); box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: width 0.3s ease-in-out; }
        .nav-item { display: flex; align-items: center; padding: 15px; cursor: pointer; position: relative; overflow: hidden; color: var(--nav-icon-color); }
        .nav-item:hover { background-color: color-mix(in srgb, var(--nav-bg) 90%, var(--primary-color)); }
        .nav-item.active { color: var(--nav-icon-active-color); }
        .nav-item .icon-wrapper { width: 24px; height: 24px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }
        .nav-item-label { margin-left: 20px; white-space: nowrap; animation: fadeIn 0.3s forwards; display: none; }

        #main-content { width: 100%; padding: 20px; box-sizing: border-box; animation: fadeIn 0.5s ease-out; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s; }

        .card { background-color: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px var(--card-shadow); animation: fadeIn 0.6s; }
        #setup-card, #settings-card, #history-card, #info-card { max-width: 700px; margin: 20px auto; }
        .card h2 { margin-top: 0; margin-bottom: 10px; font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .card .card-description { margin-top: -5px; margin-bottom: 20px; color: var(--secondary-text); }

        .content-grid { display: grid; gap: 25px; }
        #game-blocker { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.2); backdrop-filter: blur(4px); z-index: 50; display: flex; justify-content: center; align-items: center; text-align: center; padding: 20px; border-radius: 12px; color: var(--text-color); font-size: 1.2em; font-weight: 500; display: none; }
        #game-blocker.active { display: flex; animation: fadeIn 0.3s; }
        #game-play-card { position: relative; }

        .settings-item { display: flex; flex-direction: column; align-items: flex-start; padding: 15px 0; border-bottom: 1px solid var(--border-color); gap: 10px; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .api-key-container { width: 100%; display: flex; flex-direction: column; gap: 8px; }
        .api-key-container input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-color); color: var(--text-color); font-family: 'Roboto', sans-serif; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;}
        .api-key-container input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); outline: none; }
        .api-key-container .button-group { justify-content: flex-end; }
        .api-key-status { font-size: 0.8em; color: var(--secondary-text); }
        .api-key-status.saved { color: #27ae60; }

        @media (min-width: 768px) {
            .app-container { padding-left: var(--nav-width-collapsed); transition: padding-left 0.3s ease-in-out; }
            #main-nav { width: var(--nav-width-collapsed); height: 100vh; top: 0; left: 0; display: flex; flex-direction: column; padding-top: 20px; }
            #main-nav:hover { width: var(--nav-width-expanded); }
            #main-nav:hover .nav-item-label { display: inline; }
            .nav-item.active::before { content: ''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; background-color: var(--nav-icon-active-color); border-radius: 0 4px 4px 0; }
            .content-grid.show-data-panel { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 767px) {
            .app-container { padding-top: 60px; }
            #main-nav { width: 100vw; height: 60px; top: 0; left: 0; display: flex; justify-content: space-around; align-items: center; }
            .nav-item { padding: 5px; flex-grow: 1; justify-content: center; }
            .nav-item-label { display: none !important; }
            .nav-item.active::before { content: ''; position: absolute; bottom: 0; left: 10px; right: 10px; height: 4px; background-color: var(--nav-icon-active-color); border-radius: 4px 4px 0 0; }
            h1 { font-size: 2em; }
            #main-content { padding: 15px; }
        }

        h1 { text-align: center; font-size: 2.5em; font-weight: 700; margin: 0 0 25px 0; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        button { font-family: 'Roboto', sans-serif; font-size: 1em; font-weight: 500; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; background-color: var(--primary-color); color: white; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: var(--primary-hover); }
        button:disabled { background-color: var(--disabled-bg); color: var(--disabled-text); cursor: not-allowed; }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        button.warning { background-color: var(--warning-color); }
        button.warning:hover:not(:disabled) { background-color: var(--warning-hover); }

        .mode-card-option { padding: 20px; border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: border-color 0.2s, background-color 0.2s; }
        .mode-card-option:hover { border-color: var(--primary-color); background-color: color-mix(in srgb, var(--card-bg) 95%, var(--primary-color)); }

        .card-header { display: flex; justify-content: space-between; align-items: center; }
        #round-info { font-size: 1em; color: var(--secondary-text); font-weight: 500; }

        #scoreboard { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; text-align: center; gap: 15px; margin: 20px 0; }
        .score-display { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 8px; font-weight: 500; transition: box-shadow 0.3s; }
        .score-display .score-label { font-size: 0.9em; font-weight: 400; color: var(--secondary-text); }
        .score-display.leading { box-shadow: 0 0 15px var(--win-glow); }
        .score-display span { font-size: 1.5em; font-weight: 700; display: block; }
        #draw-score-display { font-size: 0.9em; opacity: 0.7; }

        #game-display { display: flex; justify-content: space-around; align-items: center; margin: 25px 0; }
        .player-area, .ai-area { text-align: center; width: 100px; position: relative; }
        .hand-display { font-size: 3em; min-width: 80px; min-height: 80px; line-height: 80px; display: flex; justify-content: center; align-items: center; }
        .hand-display svg { width: 1em; height: 1em; fill: var(--text-color); }
        
        .loader-container { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; justify-content: center; align-items: center; }
        .loader { width: 50px; height: 50px; animation: rotate 2s linear infinite; transform-origin: center center; }
        .loader .path { stroke: var(--primary-color); stroke-linecap: round; animation: dash 1.5s ease-in-out infinite; }

        #result-display { text-align: center; margin: 20px 0; padding: 15px; border-radius: 8px; font-size: 1.3em; font-weight: 700; }
        .result-win { background-color: var(--win-glow); color: #27ae60; }
        .result-lose { background-color: var(--lose-glow); color: var(--danger-color); }
        .result-draw { background-color: var(--draw-glow); color: var(--secondary-text); }
        #turn-indicator { min-height: 1.2em; margin-bottom: 15px; font-weight: 500; color: var(--secondary-text); }
        .controls-group { margin-top: 20px; }

        .chart-container { width: 100%; }
        #hands-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; }
        
        #history-list { list-style: none; padding: 0; margin: 0; border: 1px solid var(--border-color); border-radius: 8px; }
        .history-item { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .history-item:hover { background-color: color-mix(in srgb, var(--card-bg) 95%, var(--primary-color)); }
        .history-item:last-child { border-bottom: none; }
        .history-meta { display: flex; flex-direction: column; gap: 5px; font-size: 0.9em; pointer-events: none; }
        .history-mode { font-weight: 700; color: var(--primary-color); }
        .history-date { font-size: 0.9em; color: var(--secondary-text); }
        .history-result-summary { display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .history-final-score { font-weight: 700; font-size: 1.2em; }
        .history-score-breakdown { font-size: 0.9em; color: var(--secondary-text); }
        .history-winner { font-weight: 700; font-size: 1.1em;}
        .history-winner.win { color: #27ae60; }
        .history-winner.lose { color: var(--danger-color); }
        .history-winner.draw { color: var(--secondary-text); }
        #no-history-message { text-align: center; color: var(--secondary-text); padding: 40px 20px; }
        
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .history-controls { display: flex; align-items: center; gap: 10px; }
        .filter-container { position: relative; }
        button.secondary-button {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
        }
        button.secondary-button:hover {
            background-color: color-mix(in srgb, var(--card-bg) 95%, var(--primary-color));
            border-color: var(--primary-color);
        }
        button.secondary-button svg { width: 16px; height: 16px; fill: currentColor; }
        .filter-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 10;
            width: 200px;
            overflow: hidden;
            animation: fadeIn 0.2s;
        }
        .filter-dropdown.show { display: block; }
        .filter-dropdown ul { list-style: none; padding: 5px 0; margin: 0; }
        .filter-dropdown li a {
            display: block;
            padding: 8px 15px;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .filter-dropdown li a:hover { background-color: color-mix(in srgb, var(--card-bg) 90%, var(--primary-color)); }
        .filter-dropdown .filter-header {
            padding: 8px 15px;
            font-size: 0.8em;
            font-weight: 700;
            color: var(--secondary-text);
            text-transform: uppercase;
        }
        .filter-dropdown .filter-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 12px; max-width: 90%; width: 600px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: fadeIn 0.3s; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px; flex-shrink: 0; }
        .modal-title { font-size: 1.4em; font-weight: 700; margin: 0; }
        
        .modal-close-button { border: none; background: transparent; color: var(--text-color); cursor: pointer; opacity: 0.7; transition: opacity 0.2s; padding: 5px; display: flex; align-items: center; justify-content: center; }
        .modal-close-button:hover { opacity: 1; }
        .modal-close-button svg { width: 20px; height: 20px; }

        .modal-body { overflow-y: auto; }
        .detail-list { list-style: none; padding: 0; margin: 0; }
        .detail-item { display: grid; grid-template-columns: auto 1fr auto; gap: 15px; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .detail-item:last-child { border-bottom: none; }
        .detail-round { font-size: 0.9em; color: var(--secondary-text); font-weight: 500; }
        .detail-hands { display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 1.1em; }
        .detail-result { font-weight: 700; font-size: 0.9em; padding: 3px 6px; border-radius: 5px; width: 80px; text-align: center; }
        .detail-result.win { background-color: var(--win-glow); color: #27ae60; }
        .detail-result.lose { background-color: var(--lose-glow); color: var(--danger-color); }
        .detail-result.draw { background-color: var(--draw-glow); color: var(--secondary-text); }
        #modal-charts-container { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }

        #notification-area { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 8px; background-color: color-mix(in srgb, var(--card-bg) 95%, black); color: var(--text-color); box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #notification-area.show { opacity: 1; pointer-events: auto; }

        @media (max-width: 767px) {
            #scoreboard { grid-template-columns: 1fr; gap: 5px; }
            .hand-display { font-size: 3em; }
            .player-area, .ai-area { width: 100px; }
            .history-item { grid-template-columns: 1fr; text-align: center; }
            .detail-item { text-align: center; }
        }

        .back-button {
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s, color 0.2s;
        }
        .back-button:hover {
            opacity: 1;
            color: var(--text-color);
        }
        .back-button svg {
            width: 20px;
            height: 20px;
        }

        .ai-model-selector {
            position: relative;
            font-family: 'Roboto', sans-serif;
        }
        .ai-model-selector-header {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .ai-model-selector-header:hover {
            border-color: var(--primary-color);
            background-color: color-mix(in srgb, var(--card-bg) 95%, var(--primary-color));
        }
        .ai-model-selector-header .model-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .ai-model-selector-header .model-name {
            font-weight: 500;
        }
        .ai-model-selector-header .model-id {
            font-size: 0.8em;
            color: var(--secondary-text);
        }
        .ai-model-selector-header .selector-icon {
            transition: transform 0.2s;
        }
        .ai-model-selector.open .selector-icon {
            transform: rotate(180deg);
        }
        .ai-model-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 20;
            overflow: hidden;
            animation: fadeIn 0.2s;
        }
        .ai-model-selector.open .ai-model-dropdown {
            display: block;
        }
        .ai-model-dropdown ul {
            list-style: none;
            padding: 5px 0;
            margin: 0;
        }
        .ai-model-dropdown li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .ai-model-dropdown li:hover {
            background-color: color-mix(in srgb, var(--card-bg) 90%, var(--primary-color));
        }
        .ai-model-dropdown .model-id {
            display: none;
        }
        .ai-model-dropdown .check-icon {
            visibility: hidden;
            color: var(--primary-color);
        }
        .ai-model-dropdown li.selected .check-icon {
            visibility: visible;
        }

        #info-card .info-section {
            margin-bottom: 30px;
        }
        #info-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        #info-card p, #info-card li {
            line-height: 1.8;
            color: var(--text-color);
        }
        #info-card table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        #info-card th, #info-card td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }
        #info-card th {
            background-color: color-mix(in srgb, var(--bg-color) 80%, var(--secondary-text));
            font-weight: 700;
        }
        #info-card code {
            background-color: color-mix(in srgb, var(--border-color) 50%, transparent);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        #info-card pre code {
            display: block;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
        #info-card .info-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        #info-card .info-link:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <nav id="main-nav">
            <a class="nav-item active" data-tab="setup">
                <span class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M10.5 1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V4H1.5a.5.5 0 0 1 0-1H10V1.5a.5.5 0 0 1 .5-.5M12 3.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-6.5 2A.5.5 0 0 1 6 6v1.5h8.5a.5.5 0 0 1 0 1H6V10a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5M1 8a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2A.5.5 0 0 1 1 8m9.5 2a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V13H1.5a.5.5 0 0 1 0-1H10v-1.5a.5.5 0 0 1 .5-.5m1.5 2.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/></svg></span>
                <span class="nav-item-label">対戦設定</span>
            </a>
            <a class="nav-item" data-tab="game">
                <span class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5.784 6A2.24 2.24 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.3 6.3 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/></svg></span>
                <span class="nav-item-label">対戦</span>
            </a>
            <a class="nav-item" data-tab="history">
                <span class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
                    <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z"/>
                    <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z"/>
                    <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5"/>
                  </svg></span>
                <span class="nav-item-label">履歴</span>
            </a>
            <a class="nav-item" data-tab="settings">
                <span class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
                    <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                </svg></span>
                <span class="nav-item-label">設定</span>
            </a>
            <a class="nav-item" data-tab="info">
                <span class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info" viewBox="0 0 16 16">
                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                    </svg>
                </span>
                <span class="nav-item-label">インフォメーション</span>
            </a>
        </nav>
        <main id="main-content">
            <header>
                 <h1>じゃんけんAI <span style="font-size: 0.5em; color: var(--primary-color);">with Gemini</span></h1>
            </header>

            <section id="setup-section" class="tab-content active">
                <div id="setup-card" class="card">
                    <div id="mode-selection-container">
                        <h2>1. モード選択</h2>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="mode-card-option" data-mode="player-vs-ai"><h3>あなた VS AI (Gemini)</h3><p>AIの次の手を予測して勝利を目指せ！</p></div>
                            <div class="mode-card-option" data-mode="player-vs-player"><h3>あなた VS ユーザー2</h3><p>友達や家族と対戦しよう。</p></div>
                        </div>
                    </div>
                    <div id="game-length-container" style="display: none;">
                        <h2>
                            <span>2. 勝負回数選択</span>
                            <button id="back-to-mode-selection" class="back-button" title="モード選択に戻る">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                                </svg>
                            </button>
                        </h2>
                        <p class="card-description">何回勝負で決着をつけますか？回数が多いほど戦略が重要になります。</p>
                        <div class="button-group" id="game-length-buttons">
                            <button data-length="1">一発勝負</button> <button data-length="3">3回</button> <button data-length="5">5回</button>
                            <button data-length="10">10回</button> <button data-length="25">25回</button> <button data-length="50">50回</button>
                            <button data-length="100">100回</button> <button data-length="250">250回</button> <button data-length="500">500回</button>
                            <button data-length="1000">1000回</button> <button data-length="Infinity">無制限</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="game-section" class="tab-content">
                <div id="game-content-grid" class="content-grid">
                    <div class="control-panel">
                        <div id="game-play-card" class="card">
                            <div id="game-blocker"><div><p>最初に対戦設定をしてください。</p><button id="go-to-setup-btn">設定に移動</button></div></div>
                            <div class="card-header">
                                <h2 id="game-play-title">対戦</h2>
                                <div id="round-info">Round: 0 / 0</div>
                            </div>
                            <div id="scoreboard">
                                 <div class="score-display"> <div class="score-label">あなた</div> <span id="player-score-span">0</span> </div>
                                 <div id="draw-score-display" class="score-display"> <div class="score-label">あいこ</div> <span id="draw-score-span">0</span> </div>
                                 <div class="score-display"> <div class="score-label">AI</div> <span id="ai-score-span">0</span> </div>
                            </div>
                            <div id="game-display">
                                <div class="player-area"> <div id="player-name" class="name">あなた</div> <div id="player-hand" class="hand-display">?</div> </div>
                                <div style="font-size: 1.8em; font-weight: bold; color: var(--secondary-text);">VS</div>
                                <div class="ai-area">
                                    <div id="ai-name" class="name">AI</div>
                                    <div id="ai-hand" class="hand-display">?</div>
                                    <div id="ai-loader" class="loader-container">
                                        <svg class="loader" viewBox="0 0 50 50">
                                            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div id="result-display">結果を待っています...</div>
                            <div id="player-controls">
                                <div id="turn-indicator"></div>
                                <div class="button-group"> <button data-hand="rock">✊ グー</button> <button data-hand="paper">✋ パー</button> <button data-hand="scissors">✌️ チョキ</button> </div>
                                <div class="controls-group button-group">
                                    <button id="start-pause-button">スタート</button>
                                    <button id="quit-button" class="danger" style="display: none;">やめる</button>
                                    <button id="new-game-button" class="warning" style="display: none;">別のゲームを始める</button>
                                </div>
                            </div>
                        </div>
                        <div id="stats-card" class="card">
                            <h2>手の内訳</h2>
                            <div id="hands-stats">
                                <div> <h4 id="player1-hands-title">あなた</h4> <p>✊ グー: <span id="p1-rock-count">0</span></p> <p>✋ パー: <span id="p1-paper-count">0</span></p> <p>✌️ チョキ: <span id="p1-scissors-count">0</span></p> </div>
                                <div> <h4 id="player2-hands-title">AI</h4> <p>✊ グー: <span id="p2-rock-count">0</span></p> <p>✋ パー: <span id="p2-paper-count">0</span></p> <p>✌️ チョキ: <span id="p2-scissors-count">0</span></p> </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-panel">
                         <div id="charts-card" class="card">
                            <h2>データ分析グラフ</h2>
                            <div id="resultsChart" class="chart-container"></div>
                            <div id="handsChart" class="chart-container" style="margin-top: 25px;"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="history-section" class="tab-content">
                <div id="history-card" class="card">
                    <div class="history-header">
                        <h2>対戦履歴 (最大100件)</h2>
                        <div class="history-controls">
                            <div class="filter-container">
                                <button id="history-filter-button" class="secondary-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filter" viewBox="0 0 16 16">
                                        <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/>
                                    </svg>
                                    <span id="history-filter-label">フィルター</span>
                                </button>
                                <div id="history-filter-dropdown" class="filter-dropdown">
                                    <ul>
                                        <li><a href="#" data-filter-type="all">すべての履歴</a></li>
                                        <li class="filter-divider"></li>
                                        <li class="filter-header">勝敗で絞り込む</li>
                                        <li><a href="#" data-filter-type="result" data-filter-value="win">あなたの勝ち</a></li>
                                        <li><a href="#" data-filter-type="result" data-filter-value="lose">あなたの負け</a></li>
                                        <li><a href="#" data-filter-type="result" data-filter-value="draw">引き分け</a></li>
                                        <li class="filter-divider"></li>
                                        <li class="filter-header">モードで絞り込む</li>
                                        <li><a href="#" data-filter-type="mode" data-filter-value="あなた VS AI (Gemini)">あなた VS AI</a></li>
                                        <li><a href="#" data-filter-type="mode" data-filter-value="あなた VS ユーザー2">あなた VS ユーザー2</a></li>
                                    </ul>
                                </div>
                            </div>
                            <button id="clear-history-button" class="danger">履歴をクリア</button>
                        </div>
                    </div>
                    <ul id="history-list"></ul>
                    <p id="no-history-message">まだ対戦履歴がありません。</p>
                </div>
            </section>

            <section id="settings-section" class="tab-content">
                 <div id="settings-card" class="card">
                    <h2>設定</h2>
                    <div class="settings-item">
                        <div class="settings-item-header">
                           <label for="api-key-input">Gemini APIキー</label>
                           <span id="api-key-status"></span>
                        </div>
                        <p class="card-description" style="margin-bottom: 5px; font-size: 0.9em;">AI(Gemini)と対戦するためにAPIキーが必要です。キーはブラウザ内にのみ保存されます。</p>
                         <div class="api-key-container">
                             <input type="password" id="api-key-input" placeholder="APIキーを入力...">
                             <div class="button-group">
                                <button id="save-api-key-button">保存</button>
                             </div>
                         </div>
                    </div>

                    <div class="settings-item">
                        <div class="settings-item-header">
                            <label>対戦AIモデル</label>
                        </div>
                        <p class="card-description" style="margin-bottom: 5px; font-size: 0.9em;">
                            対戦に使用するAIを選択します。APIキーが未設定、またはエラー発生時は自動的に「旧式」が使用されます。
                        </p>
                        <div class="ai-model-selector" id="ai-model-selector">
                            <div class="ai-model-selector-header">
                                <div class="model-info">
                                    <span class="model-name" id="ai-model-current-name"></span>
                                    <span class="model-id" id="ai-model-current-id"></span>
                                </div>
                                <span class="selector-icon" id="ai-model-selector-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="ai-model-dropdown" id="ai-model-dropdown">
                                <ul>
                                    <li data-model-id="gemini-2.5-flash" data-model-label="Gemini 2.5 Flash">
                                        <div class="model-info">
                                            <span class="model-name">Gemini 2.5 Flash</span>
                                            <span class="model-id">gemini-2.5-flash</span>
                                        </div>
                                        <span class="check-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16">
                                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                            </svg>
                                        </span>
                                    </li>
                                    <li data-model-id="legacy" data-model-label="旧式">
                                        <div class="model-info">
                                            <span class="model-name">旧式</span>
                                            <span class="model-id">ランダム選択</span>
                                        </div>
                                        <span class="check-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16">
                                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                            </svg>
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="settings-item">
                        <div class="settings-item-header">
                            <label for="popups-enabled-switch">手のポップアップアニメーション</label>
                            <label class="switch"><input type="checkbox" id="popups-enabled-switch" checked><span class="slider"></span></label>
                        </div>
                    </div>
                     <div class="settings-item">
                        <div class="settings-item-header">
                            <label for="data-analysis-enabled-switch">データ分析パネルの表示</label>
                            <label class="switch"><input type="checkbox" id="data-analysis-enabled-switch" checked><span class="slider"></span></label>
                        </div>
                    </div>
                 </div>
            </section>
            
            <section id="info-section" class="tab-content">
                <div id="info-card" class="card">
                    <h2>インフォメーション</h2>
            
                    <div class="info-section">
                        <h3>このアプリケーションについて</h3>
                        <p>
                            「じゃんけんAI with Gemini」は、Googleの最新AIモデル「Gemini」を搭載した先進的なじゃんけん対戦アプリケーションです。単なる運試しのゲームではなく、AIとの高度な心理戦、友人との対戦、そして詳細なデータ分析を通じて、じゃんけんの奥深さを探求することができます。
                        </p>
                        <p>
                            このアプリケーションは、最新のウェブ技術を駆使して単一のHTMLファイルで構築されており、モダンなUI/UXデザインと高いインタラクティブ性を実現しています。ユーザーの皆様に最高のじゃんけん体験を提供することを目指して開発されました。
                        </p>
                    </div>
            
                    <div class="info-section">
                        <h3>遊び方と機能解説</h3>
                        <p>本アプリケーションは、直感的な操作で誰でも簡単にお楽しみいただけます。主な機能は以下の通りです。</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>機能</th>
                                    <th>説明</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>対戦設定</strong></td>
                                    <td>ゲームを開始する前に、ここですべての設定を行います。「あなた VS AI」モードか「あなた VS ユーザー2」モードを選択し、次に対戦回数を決定します。無制限にプレイすることも可能です。</td>
                                </tr>
                                <tr>
                                    <td><strong>対戦画面</strong></td>
                                    <td>ゲームプレイの中核となる画面です。スコアボード、お互いの手、そして勝敗結果がリアルタイムで表示されます。データ分析パネルを有効にしている場合は、勝負の推移を示すグラフも動的に更新されます。</td>
                                </tr>
                                <tr>
                                    <td><strong>履歴</strong></td>
                                    <td>過去の対戦結果を最大100件まで自動で保存・閲覧できます。フィルター機能を使えば、「AIに勝った試合だけ」や「友達と遊んだ試合だけ」を絞り込んで表示することも可能です。各履歴をクリックすると、全ラウンドの詳細な内容と統計グラフを確認できます。</td>
                                </tr>
                                <tr>
                                    <td><strong>設定</strong></td>
                                    <td>アプリケーションの動作をカスタマイズします。Gemini AIと対戦するためのAPIキーの設定、AIモデルの選択、UIアニメーションのON/OFF、データ分析パネルの表示/非表示などを変更できます。設定はブラウザ内に安全に保存されます。</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
            
                    <div class="info-section">
                        <h3>AIモデルの解説</h3>
                        <p>このアプリケーションのAIは、設定画面から2つの異なる思考アルゴリズムを選択できます。</p>
                        <ul>
                            <li><strong>Gemini 2.5 Flash:</strong> Googleが開発した最新鋭の大規模言語モデル(LLM)です。このAIは、あなたが過去に出した最大100回の手の履歴を分析し、「次はこれを出す可能性が高い」というパターンを予測します。そして、その予測に対して最も勝率の高い手を戦略的に選択します。単なるランダムではなく、あなたの癖を読んでくるため、非常に手強い対戦相手となります。</li>
                            <li><strong>旧式 (ランダムAI):</strong> 伝統的なコンピュータのじゃんけんです。過去のデータには一切依存せず、毎回完全にランダムで手を選択します。APIキーが未設定の場合や、API通信でエラーが発生した際のフォールバックとしても機能し、ゲームが中断しないように設計されています。</li>
                        </ul>
                        <p>AIの思考ロジックの核心部分は、Geminiに送られる以下の「プロンプト」によって制御されています。</p>
                        <pre><code class="language-plaintext">あなたは「AI」という名前のじゃんけんの達人です。対戦相手の過去100回の手の履歴は次の通りです: [rock, paper, rock, ...]。
この履歴を分析し、相手が次に出す可能性が最も高い手を予測してください。そして、その手に勝つための手を考えてください。
回答は "rock", "paper", "scissors" のいずれか一つだけをJSON形式で返してください。</code></pre>
                    </div>
            
                    <div class="info-section">
                        <h3>技術スタックとライブラリ</h3>
                        <p>このアプリケーションは、外部サーバーを必要としないフロントエンド完結型のシングルページアプリケーション(SPA)として構築されています。使用している主な技術は以下の通りです。</p>
                        <ul>
                            <li><strong>HTML5 / CSS3 / JavaScript (ES6+):</strong> ウェブの標準技術をベースに構築されています。</li>
                            <li><strong>Google Gemini API:</strong> AIの思考エンジンとして<code>gemini-2.5-flash</code>モデルを利用しています。</li>
                            <li><strong>ApexCharts.js:</strong> 対戦データ（勝敗推移、手の内訳）をリッチでインタラクティブなグラフとして可視化するために使用しています。</li>
                            <li><strong>Highlight.js:</strong> このインフォメーションページでコードスニペットを美しく表示するために使用しています。</li>
                        </ul>
                        <p>
                            UIデザインは、CSS変数（カスタムプロパティ）を全面的に活用しており、ライトモードとダークモードの切り替えを効率的に実現しています。また、`localStorage` APIを利用して、ユーザーの設定や対戦履歴をブラウザに永続化させています。
                        </p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="notification-area"><p id="notification-message">メッセージ</p></div>

    <div id="history-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title">対戦詳細</h3>
                <button id="modal-close-button" class="modal-close-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <ul id="modal-detail-list" class="detail-list"></ul>
                <div id="modal-charts-container">
                    <div id="modal-results-chart" class="chart-container"></div>
                    <div id="modal-hands-chart" class="chart-container" style="margin-top: 25px;"></div>
                </div>
            </div>
        </div>
    </div>


<script>
    const HANDS = ['rock', 'paper', 'scissors'];
    const HAND_EMOJIS = { rock: '✊', paper: '✋', scissors: '✌️' };
    const WIN_CONDITIONS = { rock: 'scissors', paper: 'rock', scissors: 'paper' };
    const CHECK_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/></svg>`;

    let gameState = {};
    let resultsChart = null, handsChart = null;
    let modalResultsChart = null, modalHandsChart = null;
    let roundResetTimeoutId = null, notificationTimeoutId = null;

    const DOMElements = {
        navItems: document.querySelectorAll('.nav-item'),
        tabContents: document.querySelectorAll('.tab-content'),
        gameContentGrid: document.getElementById('game-content-grid'),
        modeSelectionContainer: document.getElementById('mode-selection-container'),
        gameLengthContainer: document.getElementById('game-length-container'),
        backToModeSelectionButton: document.getElementById('back-to-mode-selection'),
        modeCards: document.querySelectorAll('.mode-card-option'),
        gameLengthButtons: document.getElementById('game-length-buttons'),
        dataPanel: document.querySelector('.data-panel'),
        chartsCard: document.getElementById('charts-card'),
        gameBlocker: document.getElementById('game-blocker'),
        goToSetupBtn: document.getElementById('go-to-setup-btn'),
        roundInfo: document.getElementById('round-info'),
        playerScoreLabel: document.querySelector('#scoreboard .score-display:nth-child(1) .score-label'),
        aiScoreLabel: document.querySelector('#scoreboard .score-display:nth-child(3) .score-label'),
        playerScoreSpan: document.getElementById('player-score-span'),
        aiScoreSpan: document.getElementById('ai-score-span'),
        drawScoreSpan: document.getElementById('draw-score-span'),
        playerName: document.getElementById('player-name'), aiName: document.getElementById('ai-name'),
        playerHand: document.getElementById('player-hand'), aiHand: document.getElementById('ai-hand'),
        aiLoader: document.getElementById('ai-loader'),
        resultDisplay: document.getElementById('result-display'),
        turnIndicator: document.getElementById('turn-indicator'),
        playerControls: document.getElementById('player-controls'),
        playerChoiceButtons: document.querySelectorAll('#player-controls button[data-hand]'),
        startPauseButton: document.getElementById('start-pause-button'),
        quitButton: document.getElementById('quit-button'),
        newGameButton: document.getElementById('new-game-button'),
        p1HandsTitle: document.getElementById('player1-hands-title'), p2HandsTitle: document.getElementById('player2-hands-title'),
        p1Rock: document.getElementById('p1-rock-count'), p1Paper: document.getElementById('p1-paper-count'), p1Scissors: document.getElementById('p1-scissors-count'),
        p2Rock: document.getElementById('p2-rock-count'), p2Paper: document.getElementById('p2-paper-count'), p2Scissors: document.getElementById('p2-scissors-count'),
        popupsEnabledSwitch: document.getElementById('popups-enabled-switch'),
        dataAnalysisEnabledSwitch: document.getElementById('data-analysis-enabled-switch'),
        apiKeyInput: document.getElementById('api-key-input'),
        saveApiKeyButton: document.getElementById('save-api-key-button'),
        apiKeyStatus: document.getElementById('api-key-status'),
        historyList: document.getElementById('history-list'),
        noHistoryMessage: document.getElementById('no-history-message'),
        clearHistoryButton: document.getElementById('clear-history-button'),
        notificationArea: document.getElementById('notification-area'),
        notificationMessage: document.getElementById('notification-message'),
        historyDetailModal: document.getElementById('history-detail-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalDetailList: document.getElementById('modal-detail-list'),
        modalCloseButton: document.getElementById('modal-close-button'),
        historyFilterButton: document.getElementById('history-filter-button'),
        historyFilterDropdown: document.getElementById('history-filter-dropdown'),
        historyFilterLabel: document.getElementById('history-filter-label'),
        aiModelSelector: document.getElementById('ai-model-selector'),
        aiModelSelectorHeader: document.querySelector('.ai-model-selector-header'),
        aiModelCurrentName: document.getElementById('ai-model-current-name'),
        aiModelCurrentId: document.getElementById('ai-model-current-id'),
        aiModelSelectorIcon: document.getElementById('ai-model-selector-icon'),
        aiModelDropdown: document.getElementById('ai-model-dropdown'),
        aiModelOptions: document.querySelectorAll('#ai-model-dropdown li'),
    };

    function initializeEventListeners() {
        DOMElements.navItems.forEach(item => item.addEventListener('click', () => showTab(item.dataset.tab)));
        DOMElements.modeCards.forEach(card => card.addEventListener('click', () => selectMode(card.dataset.mode)));
        DOMElements.backToModeSelectionButton.addEventListener('click', goBackToModeSelection);
        DOMElements.gameLengthButtons.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') setGameLength(e.target.dataset.length === 'Infinity' ? Infinity : parseInt(e.target.dataset.length));
        });
        DOMElements.goToSetupBtn.addEventListener('click', () => showTab('setup'));
        DOMElements.playerChoiceButtons.forEach(button => button.addEventListener('click', () => playerChoose(button.dataset.hand)));
        DOMElements.startPauseButton.addEventListener('click', togglePause);
        DOMElements.quitButton.addEventListener('click', quitGame);
        DOMElements.newGameButton.addEventListener('click', () => { resetGame(); showTab('setup'); });
        DOMElements.popupsEnabledSwitch.addEventListener('change', (e) => { gameState.settings.popupsEnabled = e.target.checked; saveSettings(); });
        DOMElements.dataAnalysisEnabledSwitch.addEventListener('change', (e) => {
            gameState.settings.dataAnalysisEnabled = e.target.checked;
            DOMElements.dataPanel.style.display = e.target.checked ? 'flex' : 'none';
            DOMElements.gameContentGrid.classList.toggle('show-data-panel', e.target.checked);
            if(e.target.checked && (!resultsChart || !handsChart)) initializeCharts();
            saveSettings();
        });
        DOMElements.saveApiKeyButton.addEventListener('click', saveApiKey);
        DOMElements.clearHistoryButton.addEventListener('click', clearHistory);
        DOMElements.modalCloseButton.addEventListener('click', hideHistoryDetail);
        DOMElements.historyDetailModal.addEventListener('click', (e) => {
            if (e.target === DOMElements.historyDetailModal) hideHistoryDetail();
        });
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            updateAllChartsTheme();
            if(DOMElements.historyDetailModal.style.display === 'flex') {
                const opts = getChartOptions(window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (modalResultsChart) modalResultsChart.updateOptions(opts);
                if (modalHandsChart) modalHandsChart.updateOptions(opts);
            }
        });
        DOMElements.historyFilterButton.addEventListener('click', (e) => {
            e.stopPropagation();
            DOMElements.historyFilterDropdown.classList.toggle('show');
        });
        DOMElements.historyFilterDropdown.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.tagName === 'A') {
                const type = e.target.dataset.filterType;
                const value = e.target.dataset.filterValue;
                const label = e.target.textContent;
                applyHistoryFilter(type, value, label);
            }
        });
        DOMElements.aiModelSelectorHeader.addEventListener('click', () => {
            DOMElements.aiModelSelector.classList.toggle('open');
            const icon = DOMElements.aiModelSelector.classList.contains('open') 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-up" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708z"/></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/></svg>`;
            DOMElements.aiModelSelectorIcon.innerHTML = icon;
        });
        DOMElements.aiModelOptions.forEach(option => {
            option.addEventListener('click', (e) => {
                const target = e.currentTarget;
                const modelId = target.dataset.modelId;
                const modelLabel = target.dataset.modelLabel;
                gameState.settings.aiModel = modelId;
                gameState.settings.aiModelLabel = modelLabel;
                saveSettings();
                updateAiModelSelectorUI();
                DOMElements.aiModelSelector.classList.remove('open');
                DOMElements.aiModelSelectorIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/></svg>`;
            });
        });
        window.addEventListener('click', (e) => {
            if (!DOMElements.historyFilterButton.contains(e.target)) {
                DOMElements.historyFilterDropdown.classList.remove('show');
            }
            if (!DOMElements.aiModelSelector.contains(e.target)) {
                DOMElements.aiModelSelector.classList.remove('open');
                DOMElements.aiModelSelectorIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/></svg>`;
            }
        });
    }

    function updateAiModelSelectorUI() {
        const { aiModel, aiModelLabel } = gameState.settings;
        DOMElements.aiModelCurrentName.textContent = aiModelLabel;
        
        const selectedOption = document.querySelector(`#ai-model-dropdown li[data-model-id="${aiModel}"]`);
        DOMElements.aiModelCurrentId.textContent = selectedOption.querySelector('.model-id').textContent;
        
        DOMElements.aiModelOptions.forEach(opt => opt.classList.remove('selected'));
        selectedOption.classList.add('selected');
    }

    function showTab(tabId) {
        if (tabId === 'game' && !gameState.setupComplete) {
            DOMElements.gameBlocker.classList.add('active');
        } else {
            DOMElements.gameBlocker.classList.remove('active');
        }
        DOMElements.navItems.forEach(item => item.classList.toggle('active', item.dataset.tab === tabId));
        DOMElements.tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabId}-section`));
    }

    function selectMode(mode) {
        if (mode === 'player-vs-ai' && !gameState.settings.apiKey && gameState.settings.aiModel !== 'legacy') {
            showNotification('先に設定画面でAPIキーを設定するか、AIモデルを「旧式」に変更してください。', 4000);
            showTab('settings');
            return;
        }
        gameState.mode = mode;
        let p1Name = 'あなた', p2Name = 'AI';
        if (mode === 'player-vs-player') { p1Name = 'あなた'; p2Name = 'ユーザー2'; }
        
        [DOMElements.playerName, DOMElements.p1HandsTitle, DOMElements.playerScoreLabel].forEach(el => el.textContent = p1Name);
        [DOMElements.aiName, DOMElements.p2HandsTitle, DOMElements.aiScoreLabel].forEach(el => el.textContent = p2Name);
        DOMElements.modeSelectionContainer.style.display = 'none';
        DOMElements.gameLengthContainer.style.display = 'block';
        DOMElements.gameLengthContainer.style.animation = 'fadeIn 0.6s';
    }
    
    function goBackToModeSelection() {
        DOMElements.gameLengthContainer.style.display = 'none';
        DOMElements.modeSelectionContainer.style.display = 'block';
        DOMElements.modeSelectionContainer.style.animation = 'fadeIn 0.6s';
    }

    function setGameLength(length) {
        resetGame(length);
        gameState.setupComplete = true;
        DOMElements.playerControls.style.display = 'block';
        if (gameState.settings.dataAnalysisEnabled) initializeCharts();
        updateUI();
        showTab('game');
    }

    async function playerChoose(hand) {
        if (gameState.isPaused || gameState.isOver || !DOMElements.playerChoiceButtons[0].disabled === false) return;
        DOMElements.playerChoiceButtons.forEach(b => b.disabled = true);
        clearTimeout(roundResetTimeoutId);

        if (gameState.mode === 'player-vs-ai') {
            toggleAiLoader(true);
            const aiHand = await getGeminiHand(gameState.history.p1, DOMElements.aiName.textContent);
            toggleAiLoader(false);

            if (aiHand) {
                playRound(hand, aiHand);
            }
        } else if (gameState.mode === 'player-vs-player') {
            if (gameState.currentPlayer === 'p1') {
                gameState.p1TurnChoice = hand;
                gameState.currentPlayer = 'p2';
                DOMElements.playerHand.innerHTML = CHECK_SVG;
                DOMElements.aiHand.textContent = '?';
                 // ▼▼▼ 変更/追加 ▼▼▼: ユーザー2の番になったらボタンを有効化する
                DOMElements.playerChoiceButtons.forEach(b => b.disabled = false);
            } else {
                playRound(gameState.p1TurnChoice, hand);
            }
        }
        updateUI();
        if(gameState.mode !== 'player-vs-player') {
             DOMElements.playerChoiceButtons.forEach(b => b.disabled = false);
        }
    }

    function quitGame() {
        gameState.isOver = true;
        gameState.isPaused = true;
        logCompletedGame();
        updateUI();
    }

    function togglePause() {
        if (gameState.isOver) return;
        gameState.isPaused = !gameState.isPaused;
        clearTimeout(roundResetTimeoutId);
        setResultMessage(gameState.isPaused ? '一時停止中...' : getWaitingMessage(), 'draw');
        updateUI();
    }

    function playRound(hand1, hand2) {
        if (gameState.isOver) return;
        gameState.currentRound++;
        gameState.handsCount.p1[hand1]++;
        gameState.handsCount.p2[hand2]++;
        gameState.history.p1.push(hand1);
        gameState.history.p2.push(hand2);

        const winner = determineWinner(hand1, hand2);
        let resultMessage = '', resultClass = '';
        if (winner === 'p1') { gameState.scores.p1++; resultMessage = `${DOMElements.playerName.textContent} の勝ち！`; resultClass = 'win'; }
        else if (winner === 'p2') { gameState.scores.p2++; resultMessage = `${DOMElements.aiName.textContent} の勝ち！`; resultClass = 'lose'; }
        else { gameState.scores.draw++; resultMessage = 'あいこ！'; resultClass = 'draw'; }

        gameState.history.p1_scores.push(gameState.scores.p1);
        gameState.history.p2_scores.push(gameState.scores.p2);
        gameState.history.draw_scores.push(gameState.scores.draw);
        gameState.history.rounds.push(gameState.currentRound);
        updateHandDisplays(hand1, hand2);
        setResultMessage(resultMessage, resultClass);
        if (gameState.settings.dataAnalysisEnabled) updateAllCharts();
        updateUI();
        checkGameEnd();
        if (!gameState.isOver && !gameState.isPaused) {
            const delay = 2000;
            roundResetTimeoutId = setTimeout(() => { 
                if (gameState.isOver || gameState.isPaused) return; 
                resetHandDisplays(); 
                setResultMessage(getWaitingMessage()); 
                // ▼▼▼ 変更/追加 ▼▼▼: player-vs-playerモードのラウンドリセット後処理
                if (gameState.mode === 'player-vs-player') {
                    gameState.currentPlayer = 'p1';
                    DOMElements.playerChoiceButtons.forEach(b => b.disabled = false);
                }
                updateUI(); 
            }, delay);
        }
    }

    function determineWinner(hand1, hand2) { if (hand1 === hand2) return 'draw'; return WIN_CONDITIONS[hand1] === hand2 ? 'p1' : 'p2'; }
    
    async function getGeminiHand(opponentHistory, myName = 'AI') {
        const { aiModel, apiKey } = gameState.settings;

        if (aiModel === 'legacy') {
            return HANDS[Math.floor(Math.random() * 3)];
        }

        if (!apiKey) {
            showNotification('APIキー未設定のため、旧式AIを使用します。', 3000);
            return HANDS[Math.floor(Math.random() * 3)];
        }

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        const historyText = opponentHistory.slice(-100).join(', ') || 'まだありません';

        const prompt = `あなたは「${myName}」という名前のじゃんけんの達人です。対戦相手の過去100回の手の履歴は次の通りです: [${historyText}]。
        この履歴を分析し、相手が次に出す可能性が最も高い手を予測してください。そして、その手に勝つための手を考えてください。
        回答は "rock", "paper", "scissors" のいずれか一つだけをJSON形式で返してください。
        例: {"hand": "paper"}`;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        temperature: 1.0,
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Gemini API Error:', errorData);
                showNotification(`APIエラーのため旧式AIを使用: ${errorData.error.message}`, 5000);
                return HANDS[Math.floor(Math.random() * 3)];
            }

            const data = await response.json();
            const aiHandText = data.candidates[0].content.parts[0].text.trim();
            const parsedHand = JSON.parse(aiHandText).hand;

            if (HANDS.includes(parsedHand)) {
                return parsedHand;
            } else {
                return HANDS[Math.floor(Math.random() * 3)];
            }
        } catch (error) {
            console.error('Fetch Error:', error);
            showNotification('通信エラーのため旧式AIを使用します。', 4000);
            return HANDS[Math.floor(Math.random() * 3)];
        }
    }

    function checkGameEnd() {
        if (gameState.gameLength !== Infinity && gameState.currentRound >= gameState.gameLength) {
            gameState.isOver = true;
            gameState.isPaused = true;
            let finalMessage = '勝負終了！ ';
            if (gameState.scores.p1 > gameState.scores.p2) finalMessage += `${DOMElements.playerName.textContent} の完全勝利！`;
            else if (gameState.scores.p2 > gameState.scores.p1) finalMessage += `${DOMElements.aiName.textContent} の完全勝利！`;
            else finalMessage += '引き分けです！';
            setResultMessage(finalMessage, 'draw');
            showNotification(finalMessage, 3000);
            logCompletedGame();
        }
        updateUI();
    }
    
    function updateUI() {
        const lengthDisplay = gameState.gameLength === Infinity ? '∞' : gameState.gameLength;
        DOMElements.roundInfo.textContent = `Round: ${gameState.currentRound} / ${lengthDisplay}`;
        DOMElements.playerScoreSpan.textContent = gameState.scores.p1;
        DOMElements.aiScoreSpan.textContent = gameState.scores.p2;
        DOMElements.drawScoreSpan.textContent = gameState.scores.draw;
        const p1ScoreEl = DOMElements.playerScoreSpan.parentElement;
        const p2ScoreEl = DOMElements.aiScoreSpan.parentElement;
        p1ScoreEl.classList.toggle('leading', gameState.scores.p1 > gameState.scores.p2);
        p2ScoreEl.classList.toggle('leading', gameState.scores.p2 > gameState.scores.p1);
        DOMElements.p1Rock.textContent = gameState.handsCount.p1.rock;
        DOMElements.p1Paper.textContent = gameState.handsCount.p1.paper;
        DOMElements.p1Scissors.textContent = gameState.handsCount.p1.scissors;
        DOMElements.p2Rock.textContent = gameState.handsCount.p2.rock;
        DOMElements.p2Paper.textContent = gameState.handsCount.p2.paper;
        DOMElements.p2Scissors.textContent = gameState.handsCount.p2.scissors;
        
        const isPlayerTurn = !gameState.isPaused && !gameState.isOver;
        DOMElements.playerChoiceButtons.forEach(b => b.disabled = !isPlayerTurn);
        
        const startBtn = DOMElements.startPauseButton;
        const quitBtn = DOMElements.quitButton;
        const newGameBtn = DOMElements.newGameButton;
        
        [startBtn, quitBtn, newGameBtn].forEach(b => b.style.display = 'none');

        if (gameState.isOver) {
            newGameBtn.style.display = 'inline-block';
        } else {
            startBtn.style.display = 'inline-block';
            if (!gameState.isPaused) quitBtn.style.display = 'inline-block';
            
            if (gameState.isPaused) {
                startBtn.textContent = 'スタート';
                startBtn.classList.remove('warning');
            } else {
                startBtn.textContent = '一時停止';
                startBtn.classList.add('warning');
            }
        }
        DOMElements.turnIndicator.style.display = gameState.mode === 'player-vs-player' ? 'block' : 'none';
        if (gameState.mode === 'player-vs-player') DOMElements.turnIndicator.textContent = isPlayerTurn ? `${gameState.currentPlayer === 'p1' ? DOMElements.playerName.textContent : DOMElements.aiName.textContent} の番です` : '';
    }

    function updateHandDisplays(hand1, hand2) {
        [DOMElements.playerHand, DOMElements.aiHand].forEach(el => el.classList.remove('pop-in'));
        void DOMElements.playerHand.offsetWidth;
        DOMElements.playerHand.innerHTML = HAND_EMOJIS[hand1];
        DOMElements.aiHand.innerHTML = HAND_EMOJIS[hand2];
    }

    function resetHandDisplays() { clearTimeout(roundResetTimeoutId); [DOMElements.playerHand, DOMElements.aiHand].forEach(el => { el.innerHTML = '?'; }); }
    function setResultMessage(message, type = '') { DOMElements.resultDisplay.textContent = message; DOMElements.resultDisplay.className = 'result-display'; if (type) DOMElements.resultDisplay.classList.add(`result-${type}`); }
    function getWaitingMessage() { if (gameState.isOver) return DOMElements.resultDisplay.textContent; if (gameState.isPaused && gameState.currentRound === 0) return '「スタート」を押して開始'; if (gameState.isPaused) return '一時停止中...'; let who = gameState.mode === 'player-vs-player' ? (gameState.currentPlayer === 'p1' ? DOMElements.playerName.textContent : DOMElements.aiName.textContent) : 'あなた'; return `${who}の手を選択してください`; }

    function resetGame(length = 0) {
        const savedSettings = JSON.parse(localStorage.getItem('jankenAiSettings')) || {};
        const savedLog = JSON.parse(localStorage.getItem('jankenAiGameLog')) || [];

        gameState = {
            mode: gameState.mode || '', gameLength: length, setupComplete: false, currentRound: 0,
            scores: { p1: 0, p2: 0, draw: 0 },
            handsCount: { p1: { rock: 0, paper: 0, scissors: 0 }, p2: { rock: 0, paper: 0, scissors: 0 } },
            history: { p1: [], p2: [], rounds: [0], p1_scores: [0], p2_scores: [0], draw_scores: [0] },
            gameLog: savedLog,
            isPaused: true, isOver: false,
            p1TurnChoice: null, currentPlayer: 'p1',
            settings: {
                popupsEnabled: savedSettings.popupsEnabled !== undefined ? savedSettings.popupsEnabled : true,
                dataAnalysisEnabled: savedSettings.dataAnalysisEnabled !== undefined ? savedSettings.dataAnalysisEnabled : true,
                apiKey: savedSettings.apiKey || '',
                aiModel: savedSettings.aiModel || 'gemini-2.5-flash',
                aiModelLabel: savedSettings.aiModelLabel || 'Gemini 2.5 Flash',
            },
            historyFilter: { type: 'all', value: null },
        };
        clearTimeout(roundResetTimeoutId);
        
        DOMElements.popupsEnabledSwitch.checked = gameState.settings.popupsEnabled;
        DOMElements.dataAnalysisEnabledSwitch.checked = gameState.settings.dataAnalysisEnabled;
        DOMElements.apiKeyInput.value = gameState.settings.apiKey;
        updateApiKeyStatus();
        updateHistoryUI();
        updateAiModelSelectorUI();

        DOMElements.dataPanel.style.display = gameState.settings.dataAnalysisEnabled ? 'flex' : 'none';
        DOMElements.gameContentGrid.classList.toggle('show-data-panel', gameState.settings.dataAnalysisEnabled);
        DOMElements.modeSelectionContainer.style.display = 'block';
        DOMElements.gameLengthContainer.style.display = 'none';
        resetHandDisplays();
        setResultMessage('「スタート」を押して開始');
        updateUI();
    }
    
    function saveSettings() {
        localStorage.setItem('jankenAiSettings', JSON.stringify(gameState.settings));
    }

    function saveApiKey() {
        gameState.settings.apiKey = DOMElements.apiKeyInput.value.trim();
        saveSettings();
        updateApiKeyStatus();
        showNotification('APIキーを保存しました。', 2000);
    }

    function updateApiKeyStatus() {
        if (gameState.settings.apiKey) {
            DOMElements.apiKeyStatus.textContent = '保存済み';
            DOMElements.apiKeyStatus.classList.add('saved');
        } else {
            DOMElements.apiKeyStatus.textContent = '未設定';
            DOMElements.apiKeyStatus.classList.remove('saved');
        }
    }

    function toggleAiLoader(show) {
        const displayStyle = show ? 'flex' : 'none';
        DOMElements.aiLoader.style.display = displayStyle;
        DOMElements.aiHand.style.display = show ? 'none' : 'flex';
    }
    
    function logCompletedGame() {
        if(gameState.currentRound === 0) return;

        const modeText = {
            'player-vs-ai': 'あなた VS AI (Gemini)',
            'player-vs-player': 'あなた VS ユーザー2'
        }[gameState.mode];

        const logEntry = {
            gameId: new Date().toISOString(),
            mode: modeText,
            p1Name: DOMElements.playerName.textContent,
            p2Name: DOMElements.aiName.textContent,
            finalScore: { ...gameState.scores },
            gameLength: gameState.gameLength,
            roundDetails: {
                p1_hands: [...gameState.history.p1],
                p2_hands: [...gameState.history.p2],
            }
        };

        gameState.gameLog.push(logEntry);
        if (gameState.gameLog.length > 100) {
            gameState.gameLog.shift();
        }
        localStorage.setItem('jankenAiGameLog', JSON.stringify(gameState.gameLog));
        updateHistoryUI();
    }
    
    function applyHistoryFilter(type, value, label) {
        gameState.historyFilter = { type, value };
        DOMElements.historyFilterLabel.textContent = label;
        DOMElements.historyFilterDropdown.classList.remove('show');
        updateHistoryUI();
    }

    function updateHistoryUI() {
        const list = DOMElements.historyList;
        const noHistoryMsg = DOMElements.noHistoryMessage;
        list.innerHTML = '';

        let filteredLogs = [...gameState.gameLog];
        const { type, value } = gameState.historyFilter;

        if (type !== 'all') {
            filteredLogs = filteredLogs.filter(log => {
                if (type === 'mode') {
                    return log.mode === value;
                }
                if (type === 'result') {
                    const { p1, p2 } = log.finalScore;
                    if (value === 'win') return p1 > p2;
                    if (value === 'lose') return p2 > p1;
                    if (value === 'draw') return p1 === p2;
                }
                return true;
            });
        }
        
        if (gameState.gameLog.length === 0) {
            noHistoryMsg.textContent = "まだ対戦履歴がありません。";
            noHistoryMsg.style.display = 'block';
            list.style.display = 'none';
            DOMElements.clearHistoryButton.style.display = 'none';
            DOMElements.historyFilterButton.style.display = 'none';
            return;
        }

        DOMElements.clearHistoryButton.style.display = 'block';
        DOMElements.historyFilterButton.style.display = 'inline-flex';

        if (filteredLogs.length === 0) {
            noHistoryMsg.textContent = "このフィルターに一致する履歴はありません。";
            noHistoryMsg.style.display = 'block';
            list.style.display = 'none';
            return;
        }

        noHistoryMsg.style.display = 'none';
        list.style.display = 'block';
        
        filteredLogs.reverse().forEach(log => {
            const item = document.createElement('li');
            item.className = 'history-item';
            item.dataset.gameId = log.gameId;
            item.addEventListener('click', () => showHistoryDetail(log.gameId));

            let winnerText, winnerClass;
            if (log.finalScore.p1 > log.finalScore.p2) {
                winnerText = `${log.p1Name} の勝利`;
                winnerClass = 'win';
            } else if (log.finalScore.p2 > log.finalScore.p1) {
                winnerText = `${log.p2Name} の勝利`;
                winnerClass = 'lose';
            } else {
                winnerText = '引き分け';
                winnerClass = 'draw';
            }

            const formattedDate = new Date(log.gameId).toLocaleString('ja-JP');

            item.innerHTML = `
                <div class="history-meta">
                    <div class="history-mode">${log.mode}</div>
                    <div class="history-date">${formattedDate}</div>
                </div>
                <div class="history-result-summary">
                    <div class="history-final-score">
                        ${log.p1Name} ${log.finalScore.p1} - ${log.finalScore.p2} ${log.p2Name}
                    </div>
                    <div class="history-winner ${winnerClass}">${winnerText}</div>
                    <div class="history-score-breakdown">
                        (あいこ: ${log.finalScore.draw}回 / 全${log.finalScore.p1 + log.finalScore.p2 + log.finalScore.draw}ラウンド)
                    </div>
                </div>
            `;
            list.appendChild(item);
        });
    }

    function clearHistory() {
        if (confirm('本当に対戦履歴をすべて削除しますか？この操作は取り消せません。')) {
            gameState.gameLog = [];
            localStorage.removeItem('jankenAiGameLog');
            applyHistoryFilter('all', null, 'フィルター');
            updateHistoryUI();
            showNotification('履歴をクリアしました。', 2000);
        }
    }

    function showHistoryDetail(gameId) {
        const log = gameState.gameLog.find(g => g.gameId === gameId);
        if (!log) return;

        DOMElements.modalTitle.textContent = `${new Date(log.gameId).toLocaleString('ja-JP')} の対戦詳細`;
        const detailList = DOMElements.modalDetailList;
        detailList.innerHTML = '';

        log.roundDetails.p1_hands.forEach((p1Hand, index) => {
            const p2Hand = log.roundDetails.p2_hands[index];
            const winner = determineWinner(p1Hand, p2Hand);
            let resultText, resultClass;
            if (winner === 'p1') { resultText = `${log.p1Name} 勝ち`; resultClass = 'win'; }
            else if (winner === 'p2') { resultText = `${log.p2Name} 勝ち`; resultClass = 'lose'; }
            else { resultText = 'あいこ'; resultClass = 'draw'; }

            const item = document.createElement('li');
            item.className = 'detail-item';
            item.innerHTML = `
                <div class="detail-round">Round ${index + 1}</div>
                <div class="detail-hands">${log.p1Name}: ${HAND_EMOJIS[p1Hand]} vs ${HAND_EMOJIS[p2Hand]} :${log.p2Name}</div>
                <div class="detail-result ${resultClass}">${resultText}</div>
            `;
            detailList.appendChild(item);
        });

        renderDetailCharts(log);
        DOMElements.historyDetailModal.style.display = 'flex';
    }

    function hideHistoryDetail() {
        DOMElements.historyDetailModal.style.display = 'none';
        if (modalResultsChart) {
            modalResultsChart.destroy();
            modalResultsChart = null;
        }
        if (modalHandsChart) {
            modalHandsChart.destroy();
            modalHandsChart = null;
        }
    }

    function renderDetailCharts(log) {
        if (modalResultsChart) modalResultsChart.destroy();
        if (modalHandsChart) modalHandsChart.destroy();

        const p1Scores = [0], p2Scores = [0], drawScores = [0], rounds = [0];
        let c_p1 = 0, c_p2 = 0, c_draw = 0;
        for (let i = 0; i < log.roundDetails.p1_hands.length; i++) {
            const winner = determineWinner(log.roundDetails.p1_hands[i], log.roundDetails.p2_hands[i]);
            if(winner === 'p1') c_p1++;
            else if (winner === 'p2') c_p2++;
            else c_draw++;
            p1Scores.push(c_p1);
            p2Scores.push(c_p2);
            drawScores.push(c_draw);
            rounds.push(i + 1);
        }

        const p1HandCounts = { rock: 0, paper: 0, scissors: 0 };
        const p2HandCounts = { rock: 0, paper: 0, scissors: 0 };
        log.roundDetails.p1_hands.forEach(hand => p1HandCounts[hand]++);
        log.roundDetails.p2_hands.forEach(hand => p2HandCounts[hand]++);
        
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const commonOptions = getChartOptions(isDarkMode);
        const colors = ['--accent1-color', '--accent2-color', '--accent3-color'].map(c => getComputedStyle(document.documentElement).getPropertyValue(c).trim());

        modalResultsChart = new ApexCharts(document.querySelector("#modal-results-chart"), {
            ...commonOptions, series: [{name: log.p1Name, data: rounds.map((r, i) => [r, p1Scores[i]]) }, { name: log.p2Name, data: rounds.map((r, i) => [r, p2Scores[i]]) }, { name: 'あいこ', data: rounds.map((r, i) => [r, drawScores[i]]) } ], colors: colors,
            chart: { ...commonOptions.chart, type: 'line', height: 250 },
            stroke: { curve: 'straight', width: 2 },
            xaxis: { ...commonOptions.xaxis, type: 'numeric', title: { text: 'ラウンド数' }, min: 0, max: rounds.length -1 || 1 },
            yaxis: { ...commonOptions.yaxis, title: { text: '累計スコア' }, min: 0 }, title: { text: '勝負の推移', align: 'left' }
        });

        modalHandsChart = new ApexCharts(document.querySelector("#modal-hands-chart"), {
            ...commonOptions, series: [{ name: log.p1Name, data: Object.values(p1HandCounts) }, { name: log.p2Name, data: Object.values(p2HandCounts) }], colors: colors.slice(0, 2),
            chart: { ...commonOptions.chart, type: 'bar', height: 250 },
            plotOptions: { bar: { horizontal: false, columnWidth: '55%' } },
            xaxis: { ...commonOptions.xaxis, categories: ['✊', '✋', '✌️'] }, yaxis: { ...commonOptions.yaxis, title: { text: '選択回数' } },
            title: { text: '各手の合計選択回数', align: 'left' }, dataLabels: { enabled: false }
        });
        
        modalResultsChart.render();
        modalHandsChart.render();
    }

    function getChartOptions(isDarkMode) { return { chart: { fontFamily: 'Roboto, sans-serif', foreColor: isDarkMode ? '#e0e0e0' : '#2c3e50', toolbar: { show: false }, zoom: { enabled: false }, animations: { enabled: true, easing: 'linear', dynamicAnimation: { speed: 500 } } }, xaxis: { labels: { style: { colors: isDarkMode ? '#e0e0e0' : '#2c3e50', fontFamily: 'Roboto, sans-serif' } }, axisBorder: { color: isDarkMode ? '#3a3a5e' : '#e3e8ee' }, axisTicks: { color: isDarkMode ? '#3a3a5e' : '#e3e8ee' } }, yaxis: { labels: { style: { colors: isDarkMode ? '#e0e0e0' : '#2c3e50', fontFamily: 'Roboto, sans-serif' }, formatter: (val) => Math.round(val) } }, grid: { borderColor: isDarkMode ? '#3a3a5e' : '#e3e8ee' }, legend: { labels: { colors: isDarkMode ? '#e0e0e0' : '#2c3e50', useSeriesColors: false }, markers: { radius: 4 } }, tooltip: { theme: isDarkMode ? 'dark' : 'light' } }; }
    
    function initializeCharts() {
        if (!DOMElements.dataAnalysisEnabledSwitch.checked) return;
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const commonOptions = getChartOptions(isDarkMode);
        const colors = ['--accent1-color', '--accent2-color', '--accent3-color'].map(c => getComputedStyle(document.documentElement).getPropertyValue(c).trim());
        
        if (resultsChart) resultsChart.destroy();
        resultsChart = new ApexCharts(document.querySelector("#resultsChart"), { 
            ...commonOptions, series: [], colors: colors, 
            chart: { ...commonOptions.chart, id: 'resultsChart', type: 'line', height: 300 }, 
            stroke: { curve: 'straight', width: 2 }, 
            xaxis: { ...commonOptions.xaxis, type: 'numeric', title: { text: 'ラウンド数' }, min: 0, max: 1 },
            yaxis: { ...commonOptions.yaxis, title: { text: '累計スコア' }, min: 0 }, 
            title: { text: '勝負の推移', align: 'left' } 
        });
        
        if (handsChart) handsChart.destroy();
        handsChart = new ApexCharts(document.querySelector("#handsChart"), { 
            ...commonOptions, series: [], colors: colors.slice(0, 2), 
            chart: { ...commonOptions.chart, id: 'handsChart', type: 'bar', height: 300 }, 
            plotOptions: { bar: { horizontal: false, columnWidth: '55%' } }, 
            xaxis: { ...commonOptions.xaxis, categories: ['✊', '✋', '✌️'] }, 
            yaxis: { ...commonOptions.yaxis, title: { text: '選択回数' } }, 
            title: { text: '各手の合計選択回数', align: 'left' }, 
            dataLabels: { enabled: false } 
        });

        Promise.all([resultsChart.render(), handsChart.render()]).then(() => {
            updateAllCharts();
        });
    }
    
    function updateAllCharts() {
        if (!resultsChart || !handsChart || !gameState.settings.dataAnalysisEnabled) return;

        resultsChart.updateSeries([ { name: DOMElements.p1HandsTitle.textContent, data: gameState.history.rounds.map((r, i) => [r, gameState.history.p1_scores[i]]) }, { name: DOMElements.p2HandsTitle.textContent, data: gameState.history.rounds.map((r, i) => [r, gameState.history.p2_scores[i]]) }, { name: 'あいこ', data: gameState.history.rounds.map((r, i) => [r, gameState.history.draw_scores[i]]) } ], true);
        handsChart.updateSeries([ { name: DOMElements.p1HandsTitle.textContent, data: Object.values(gameState.handsCount.p1) }, { name: DOMElements.p2HandsTitle.textContent, data: Object.values(gameState.handsCount.p2) } ]);
        
        if (resultsChart) {
            const currentRound = gameState.currentRound;
            const xAxisMin = 0;
            const xAxisMax = Math.max(currentRound, 1);
            
            resultsChart.updateOptions({
                xaxis: {
                    min: xAxisMin,
                    max: xAxisMax,
                    tickAmount: Math.min(10, xAxisMax)
                }
            });
        }
    }
    
    function updateAllChartsTheme() { if (gameState.settings.dataAnalysisEnabled) { const opts = getChartOptions(window.matchMedia('(prefers-color-scheme: dark)').matches); if (resultsChart) resultsChart.updateOptions(opts); if (handsChart) handsChart.updateOptions(opts); } }
    function showNotification(message, duration = 3000) { clearTimeout(notificationTimeoutId); DOMElements.notificationMessage.textContent = message; DOMElements.notificationArea.classList.add('show'); notificationTimeoutId = setTimeout(() => DOMElements.notificationArea.classList.remove('show'), duration); }
    
    document.addEventListener('DOMContentLoaded', () => {
        resetGame();
        initializeEventListeners();
        showTab('setup');
        hljs.highlightAll();
    });
</script>

</body>
</html>
