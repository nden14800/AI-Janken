<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>じゃんけんAI</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f9;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --card-shadow: rgba(0, 0, 0, 0.05);
            --border-color: #e3e8ee;
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --warning-color: #f39c12;
            --warning-hover: #e67e22;
            --disabled-bg: #bdc3c7;
            --disabled-text: #7f8c8d;
            --secondary-text: #7f8c8d;
            --accent1-color: #2980b9;
            --accent2-color: #c0392b;
            --accent3-color: #7f8c8d;
            --win-glow: rgba(46, 204, 113, 0.3);
            --lose-glow: rgba(231, 76, 60, 0.3);
            --draw-glow: rgba(149, 165, 166, 0.3);
            --nav-bg: #ffffff;
            --nav-icon-color: #7f8c8d;
            --nav-icon-active-color: var(--primary-color);
            --nav-width-collapsed: 60px;
            --nav-width-expanded: 220px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a2e;
                --text-color: #e0e0e0;
                --card-bg: #242444;
                --card-shadow: rgba(0, 0, 0, 0.2);
                --border-color: #3a3a5e;
                --primary-color: #4a90e2;
                --primary-hover: #63a4ff;
                --danger-color: #e94b3c;
                --danger-hover: #ff6b5a;
                --warning-color: #f2994a;
                --warning-hover: #f5b784;
                --disabled-bg: #4f4f6b;
                --disabled-text: #a0a0b8;
                --secondary-text: #a0a0b8;
                --accent1-color: #4a90e2;
                --accent2-color: #e94b3c;
                --accent3-color: #a0a0b8;
                --win-glow: rgba(80, 227, 194, 0.2);
                --lose-glow: rgba(233, 75, 60, 0.2);
                --draw-glow: rgba(160, 160, 184, 0.2);
                --nav-bg: #1e1e3f;
                --nav-icon-color: #a0a0b8;
                --nav-icon-active-color: var(--primary-color);
            }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0.7); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1.0); opacity: 1; } }

        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; }
        .app-container { display: flex; }
        
        #main-nav {
            position: fixed; z-index: 100; background-color: var(--nav-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: width 0.3s ease-in-out;
        }
        .nav-item {
            display: flex; align-items: center; padding: 15px; cursor: pointer;
            position: relative; overflow: hidden; color: var(--nav-icon-color);
        }
        .nav-item:hover { background-color: color-mix(in srgb, var(--nav-bg) 90%, var(--primary-color)); }
        .nav-item.active { color: var(--nav-icon-active-color); }
        .nav-item .icon-wrapper { width: 24px; height: 24px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }
        .nav-item-label { margin-left: 20px; white-space: nowrap; animation: fadeIn 0.3s forwards; display: none; }
        
        #main-content { width: 100%; padding: 20px; box-sizing: border-box; animation: fadeIn 0.5s ease-out; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s; }
        
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px var(--card-shadow); animation: fadeIn 0.6s; }
        #setup-card, #settings-card { max-width: 600px; margin: 20px auto; }
        .card h2 { margin-top: 0; margin-bottom: 10px; font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .card .card-description { margin-top: -5px; margin-bottom: 20px; color: var(--secondary-text); }
        
        .content-grid { display: grid; gap: 25px; }
        
        #game-blocker { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.2); backdrop-filter: blur(4px); z-index: 50; display: flex; justify-content: center; align-items: center; text-align: center; padding: 20px; border-radius: 12px; color: var(--text-color); font-size: 1.2em; font-weight: 500; display: none; }
        #game-blocker.active { display: flex; animation: fadeIn 0.3s; }
        #game-play-card { position: relative; }
        
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        @media (min-width: 768px) {
            .app-container { padding-left: var(--nav-width-collapsed); transition: padding-left 0.3s ease-in-out; }
            #main-nav { width: var(--nav-width-collapsed); height: 100vh; top: 0; left: 0; display: flex; flex-direction: column; padding-top: 20px; }
            #main-nav:hover { width: var(--nav-width-expanded); }
            #main-nav:hover .nav-item-label { display: inline; }
            .nav-item.active::before { content: ''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; background-color: var(--nav-icon-active-color); border-radius: 0 4px 4px 0; }
            .content-grid.show-data-panel { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 767px) {
            .app-container { padding-top: 60px; }
            #main-nav { width: 100vw; height: 60px; top: 0; left: 0; display: flex; justify-content: space-around; align-items: center; }
            .nav-item { padding: 5px; flex-grow: 1; justify-content: center; }
            .nav-item-label { display: none !important; }
            .nav-item.active::before { content: ''; position: absolute; bottom: 0; left: 10px; right: 10px; height: 4px; background-color: var(--nav-icon-active-color); border-radius: 4px 4px 0 0; }
            h1 { font-size: 2em; }
            #main-content { padding: 15px; }
        }

        h1 { text-align: center; font-size: 2.5em; font-weight: 700; margin: 0 0 25px 0; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        button { font-family: 'Roboto', sans-serif; font-size: 1em; font-weight: 500; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; background-color: var(--primary-color); color: white; }
        button:hover:not(:disabled) { background-color: var(--primary-hover); }
        button:disabled { background-color: var(--disabled-bg); color: var(--disabled-text); cursor: not-allowed; }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        button.warning { background-color: var(--warning-color); }
        button.warning:hover:not(:disabled) { background-color: var(--warning-hover); }

        .mode-card-option { padding: 20px; border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; }
        .mode-card-option:hover { border-color: var(--primary-color); background-color: color-mix(in srgb, var(--card-bg) 95%, var(--primary-color)); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        #round-info { font-size: 1em; color: var(--secondary-text); font-weight: 500; }
        
        #scoreboard { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; text-align: center; gap: 15px; margin: 20px 0; }
        .score-display { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 8px; font-weight: 500; }
        .score-display .score-label { font-size: 0.9em; font-weight: 400; color: var(--secondary-text); }
        .score-display.leading { box-shadow: 0 0 15px var(--win-glow); }
        .score-display span { font-size: 1.5em; font-weight: 700; display: block; }
        #draw-score-display { font-size: 0.9em; opacity: 0.7; }
        
        #game-display { display: flex; justify-content: space-around; align-items: center; margin: 25px 0; }
        .player-area, .ai-area { text-align: center; width: 100px; }
        .hand-display { font-size: 3em; min-width: 80px; min-height: 80px; line-height: 80px; display: flex; justify-content: center; align-items: center; }
        .hand-display svg { width: 1em; height: 1em; fill: var(--text-color); }
        .hand-display.pop-in { animation: popIn 0.4s ease-out forwards; }
        #result-display { text-align: center; margin: 20px 0; padding: 15px; border-radius: 8px; font-size: 1.3em; font-weight: 700; }
        .result-win { background-color: var(--win-glow); color: #27ae60; }
        .result-lose { background-color: var(--lose-glow); color: var(--danger-color); }
        .result-draw { background-color: var(--draw-glow); color: var(--secondary-text); }

        #turn-indicator { min-height: 1.2em; margin-bottom: 15px; font-weight: 500; color: var(--secondary-text); }
        .controls-group { margin-top: 20px; }
        
        /* ▼▼▼ 変更点1: グラフコンテナのCSSを調整しました ▼▼▼ */
        .chart-container {
            width: 100%;
            /* JavaScript側で高さを指定するため、ここでのheight/min-height指定は不要です。 */
            /* これにより、各グラフのサイズが柔軟に設定できます。 */
        }
        
        #hands-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; }
        
        #notification-area { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 8px; background-color: color-mix(in srgb, var(--card-bg) 95%, black); color: var(--text-color); box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #notification-area.show { opacity: 1; pointer-events: auto; }

        @media (max-width: 767px) {
            #scoreboard { grid-template-columns: 1fr; gap: 5px; }
            .hand-display { font-size: 3em; }
            .player-area, .ai-area { width: 100px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav id="main-nav">
            <a class="nav-item active" data-tab="setup">
                <span class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M10.5 1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V4H1.5a.5.5 0 0 1 0-1H10V1.5a.5.5 0 0 1 .5-.5M12 3.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-6.5 2A.5.5 0 0 1 6 6v1.5h8.5a.5.5 0 0 1 0 1H6V10a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5M1 8a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2A.5.5 0 0 1 1 8m9.5 2a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V13H1.5a.5.5 0 0 1 0-1H10v-1.5a.5.5 0 0 1 .5-.5m1.5 2.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/></svg></span>
                <span class="nav-item-label">対戦設定</span>
            </a>
            <a class="nav-item" data-tab="game">
                <span class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5.784 6A2.24 2.24 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.3 6.3 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/></svg></span>
                <span class="nav-item-label">対戦</span>
            </a>
            <a class="nav-item" data-tab="settings">
                <span class="icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
<path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413-1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
</svg></span>
                <span class="nav-item-label">設定</span>
            </a>
        </nav>
        <main id="main-content">
            <header>
                <h1>じゃんけんAI</h1>
            </header>

            <section id="setup-section" class="tab-content active">
                <div id="setup-card" class="card">
                    <div id="mode-selection-container">
                        <h2>1. モード選択</h2>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div class="mode-card-option" data-mode="player-vs-ai"><h3>あなた VS AI</h3><p>AIの次の手を予測して勝利を目指せ！</p></div>
                            <div class="mode-card-option" data-mode="ai-vs-ai"><h3>AI VS AI</h3><p>AI同士の高速対戦を観戦しよう。</p></div>
                            <div class="mode-card-option" data-mode="player-vs-player"><h3>あなた VS ユーザー2</h3><p>友達や家族と対戦しよう。</p></div>
                        </div>
                    </div>
                    <div id="game-length-container" style="display: none;">
                        <h2>2. 勝負回数選択</h2>
                        <p class="card-description">何回勝負で決着をつけますか？回数が多いほど戦略が重要になります。</p>
                        <div class="button-group" id="game-length-buttons">
                            <button data-length="1">一発勝負</button> <button data-length="3">3回</button> <button data-length="5">5回</button>
                            <button data-length="10">10回</button> <button data-length="25">25回</button> <button data-length="50">50回</button>
                            <button data-length="100">100回</button> <button data-length="250">250回</button> <button data-length="500">500回</button>
                            <button data-length="1000">1000回</button> <button data-length="Infinity">無制限</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="game-section" class="tab-content">
                <div id="game-content-grid" class="content-grid">
                    <div class="control-panel">
                        <div id="game-play-card" class="card">
                            <div id="game-blocker"><div><p>最初に対戦設定をしてください。</p><button id="go-to-setup-btn">設定に移動</button></div></div>
                            <div class="card-header">
                                <h2 id="game-play-title">対戦</h2>
                                <div id="round-info">Round: 0 / 0</div>
                            </div>
                            <div id="scoreboard">
                                 <div class="score-display"> <div class="score-label">あなた</div> <span id="player-score-span">0</span> </div>
                                 <div id="draw-score-display" class="score-display"> <div class="score-label">あいこ</div> <span id="draw-score-span">0</span> </div>
                                 <div class="score-display"> <div class="score-label">AI</div> <span id="ai-score-span">0</span> </div>
                            </div>
                            <div id="game-display">
                                <div class="player-area"> <div id="player-name" class="name">あなた</div> <div id="player-hand" class="hand-display">?</div> </div>
                                <div style="font-size: 1.8em; font-weight: bold; color: var(--secondary-text);">VS</div>
                                <div class="ai-area"> <div id="ai-name" class="name">AI</div> <div id="ai-hand" class="hand-display">?</div> </div>
                            </div>
                            <div id="result-display">結果を待っています...</div>
                            <div id="player-controls">
                                <div id="turn-indicator"></div>
                                <div class="button-group"> <button data-hand="rock">✊ グー</button> <button data-hand="paper">✋ パー</button> <button data-hand="scissors">✌️ チョキ</button> </div>
                                <div class="controls-group button-group">
                                    <button id="start-pause-button">スタート</button>
                                    <button id="quit-button" class="danger" style="display: none;">やめる</button>
                                    <button id="new-game-button" class="warning" style="display: none;">別のゲームを始める</button>
                                </div>
                            </div>
                            <div id="ai-vs-ai-controls">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                                   <label for="ai-speed-slider">対戦速度:</label>
                                   <input type="range" id="ai-speed-slider" min="1" max="200" value="10" style="flex-grow: 1; max-width: 200px;">
                                   <span id="ai-speed-display" style="font-weight: 700; min-width: 30px;">10</span>回/秒
                                </div>
                                <div class="controls-group button-group">
                                    <button id="ai-vs-ai-start-stop">スタート</button>
                                    <button id="ai-quit-button" class="danger" style="display: none;">やめる</button>
                                    <button id="ai-new-game-button" class="warning" style="display: none;">別のゲームを始める</button>
                                </div>
                            </div>
                        </div>
                        <div id="stats-card" class="card">
                            <h2>手の内訳</h2>
                            <div id="hands-stats">
                                <div> <h4 id="player1-hands-title">あなた</h4> <p>✊ グー: <span id="p1-rock-count">0</span></p> <p>✋ パー: <span id="p1-paper-count">0</span></p> <p>✌️ チョキ: <span id="p1-scissors-count">0</span></p> </div>
                                <div> <h4 id="player2-hands-title">AI</h4> <p>✊ グー: <span id="p2-rock-count">0</span></p> <p>✋ パー: <span id="p2-paper-count">0</span></p> <p>✌️ チョキ: <span id="p2-scissors-count">0</span></p> </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-panel">
                         <div id="charts-card" class="card">
                            <h2>データ分析グラフ</h2>
                            <div id="resultsChart" class="chart-container"></div>
                            <div id="handsChart" class="chart-container" style="margin-top: 25px;"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="settings-section" class="tab-content">
                 <div id="settings-card" class="card">
                    <h2>設定</h2>
                    <div class="settings-item">
                        <label for="popups-enabled-switch">手のポップアップアニメーション</label>
                        <label class="switch"><input type="checkbox" id="popups-enabled-switch" checked><span class="slider"></span></label>
                    </div>
                     <div class="settings-item">
                        <label for="data-analysis-enabled-switch">データ分析パネルの表示</label>
                        <label class="switch"><input type="checkbox" id="data-analysis-enabled-switch" checked><span class="slider"></span></label>
                    </div>
                 </div>
            </section>
        </main>
    </div>
    
    <div id="notification-area"><p id="notification-message">メッセージ</p></div>

    <script>
        const HANDS = ['rock', 'paper', 'scissors'];
        const HAND_EMOJIS = { rock: '✊', paper: '✋', scissors: '✌️' };
        const WIN_CONDITIONS = { rock: 'scissors', paper: 'rock', scissors: 'paper' };
        const CHECK_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/></svg>`;
        
        let gameState = {};
        let resultsChart = null, handsChart = null;
        let aiVsAiIntervalId = null, roundResetTimeoutId = null, notificationTimeoutId = null;
        
        const DOMElements = {
            navItems: document.querySelectorAll('.nav-item'),
            tabContents: document.querySelectorAll('.tab-content'),
            gameContentGrid: document.getElementById('game-content-grid'),
            modeSelectionContainer: document.getElementById('mode-selection-container'),
            gameLengthContainer: document.getElementById('game-length-container'),
            modeCards: document.querySelectorAll('.mode-card-option'),
            gameLengthButtons: document.getElementById('game-length-buttons'),
            dataPanel: document.querySelector('.data-panel'),
            chartsCard: document.getElementById('charts-card'),
            gameBlocker: document.getElementById('game-blocker'),
            goToSetupBtn: document.getElementById('go-to-setup-btn'),
            roundInfo: document.getElementById('round-info'),
            playerScoreLabel: document.querySelector('#scoreboard .score-display:nth-child(1) .score-label'),
            aiScoreLabel: document.querySelector('#scoreboard .score-display:nth-child(3) .score-label'),
            playerScoreSpan: document.getElementById('player-score-span'),
            aiScoreSpan: document.getElementById('ai-score-span'),
            drawScoreSpan: document.getElementById('draw-score-span'),
            playerName: document.getElementById('player-name'), aiName: document.getElementById('ai-name'),
            playerHand: document.getElementById('player-hand'), aiHand: document.getElementById('ai-hand'),
            resultDisplay: document.getElementById('result-display'),
            turnIndicator: document.getElementById('turn-indicator'),
            playerControls: document.getElementById('player-controls'),
            playerChoiceButtons: document.querySelectorAll('#player-controls button[data-hand]'),
            startPauseButton: document.getElementById('start-pause-button'),
            quitButton: document.getElementById('quit-button'),
            newGameButton: document.getElementById('new-game-button'),
            aiVsAiControls: document.getElementById('ai-vs-ai-controls'),
            aiSpeedSlider: document.getElementById('ai-speed-slider'),
            aiSpeedDisplay: document.getElementById('ai-speed-display'),
            aiStartStopButton: document.getElementById('ai-vs-ai-start-stop'),
            aiQuitButton: document.getElementById('ai-quit-button'),
            aiNewGameButton: document.getElementById('ai-new-game-button'),
            p1HandsTitle: document.getElementById('player1-hands-title'), p2HandsTitle: document.getElementById('player2-hands-title'),
            p1Rock: document.getElementById('p1-rock-count'), p1Paper: document.getElementById('p1-paper-count'), p1Scissors: document.getElementById('p1-scissors-count'),
            p2Rock: document.getElementById('p2-rock-count'), p2Paper: document.getElementById('p2-paper-count'), p2Scissors: document.getElementById('p2-scissors-count'),
            popupsEnabledSwitch: document.getElementById('popups-enabled-switch'),
            dataAnalysisEnabledSwitch: document.getElementById('data-analysis-enabled-switch'),
            notificationArea: document.getElementById('notification-area'),
            notificationMessage: document.getElementById('notification-message'),
        };

        function initializeEventListeners() {
            DOMElements.navItems.forEach(item => item.addEventListener('click', () => showTab(item.dataset.tab)));
            DOMElements.modeCards.forEach(card => card.addEventListener('click', () => selectMode(card.dataset.mode)));
            DOMElements.gameLengthButtons.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') setGameLength(e.target.dataset.length === 'Infinity' ? Infinity : parseInt(e.target.dataset.length));
            });
            DOMElements.goToSetupBtn.addEventListener('click', () => showTab('setup'));
            DOMElements.playerChoiceButtons.forEach(button => button.addEventListener('click', () => playerChoose(button.dataset.hand)));
            [DOMElements.startPauseButton, DOMElements.aiStartStopButton].forEach(btn => btn.addEventListener('click', togglePause));
            [DOMElements.quitButton, DOMElements.aiQuitButton].forEach(btn => btn.addEventListener('click', quitGame));
            [DOMElements.newGameButton, DOMElements.aiNewGameButton].forEach(btn => btn.addEventListener('click', () => { resetGame(); showTab('setup'); }));
            DOMElements.aiSpeedSlider.addEventListener('input', (e) => updateSpeedDisplay(e.target.value));
            DOMElements.popupsEnabledSwitch.addEventListener('change', (e) => gameState.settings.popupsEnabled = e.target.checked);
            DOMElements.dataAnalysisEnabledSwitch.addEventListener('change', (e) => {
                gameState.settings.dataAnalysisEnabled = e.target.checked;
                DOMElements.dataPanel.style.display = e.target.checked ? 'flex' : 'none';
                DOMElements.gameContentGrid.classList.toggle('show-data-panel', e.target.checked);
                if(e.target.checked && (!resultsChart || !handsChart)) initializeCharts();
            });
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateAllChartsTheme);
        }

        function showTab(tabId) {
            if (tabId === 'game' && !gameState.setupComplete) DOMElements.gameBlocker.classList.add('active');
            else DOMElements.gameBlocker.classList.remove('active');
            DOMElements.navItems.forEach(item => item.classList.toggle('active', item.dataset.tab === tabId));
            DOMElements.tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabId}-section`));
        }

        function selectMode(mode) {
            gameState.mode = mode;
            let p1Name = 'あなた', p2Name = 'AI';
            if (mode === 'ai-vs-ai') { p1Name = 'AI 1'; p2Name = 'AI 2'; }
            else if (mode === 'player-vs-player') { p1Name = 'あなた'; p2Name = 'ユーザー2'; }
            [DOMElements.playerName, DOMElements.p1HandsTitle, DOMElements.playerScoreLabel].forEach(el => el.textContent = p1Name);
            [DOMElements.aiName, DOMElements.p2HandsTitle, DOMElements.aiScoreLabel].forEach(el => el.textContent = p2Name);
            DOMElements.modeSelectionContainer.style.display = 'none';
            DOMElements.gameLengthContainer.style.display = 'block';
            DOMElements.gameLengthContainer.style.animation = 'fadeIn 0.6s';
        }

        function setGameLength(length) {
            resetGame(length);
            gameState.setupComplete = true;
            if (gameState.mode === 'player-vs-ai' || gameState.mode === 'player-vs-player') {
                DOMElements.playerControls.style.display = 'block';
                DOMElements.aiVsAiControls.style.display = 'none';
            } else {
                DOMElements.playerControls.style.display = 'none';
                DOMElements.aiVsAiControls.style.display = 'block';
            }
            if (gameState.settings.dataAnalysisEnabled) initializeCharts();
            updateUI();
            showTab('game');
        }

        function quitGame() {
            gameState.isOver = true;
            gameState.isPaused = true;
            if (gameState.mode === 'ai-vs-ai') stopAiVsAi();
            updateUI();
        }

        function togglePause() {
            if (gameState.isOver) return;
            gameState.isPaused = !gameState.isPaused;
            clearTimeout(roundResetTimeoutId);
            if (gameState.mode === 'ai-vs-ai') gameState.isPaused ? stopAiVsAi() : startAiVsAi();
            else setResultMessage(gameState.isPaused ? '一時停止中...' : getWaitingMessage(), 'draw');
            updateUI();
        }

        function playerChoose(hand) {
            if (gameState.isPaused || gameState.isOver) return;
            clearTimeout(roundResetTimeoutId);
            if (gameState.mode === 'player-vs-ai') {
                playRound(hand, getAiHand(gameState.history.p1));
                gameState.history.p1.push(hand);
            } else if (gameState.mode === 'player-vs-player') {
                if (gameState.currentPlayer === 'p1') {
                    gameState.p1TurnChoice = hand;
                    gameState.currentPlayer = 'p2';
                    DOMElements.playerHand.innerHTML = CHECK_SVG;
                    DOMElements.aiHand.textContent = '?';
                } else {
                    playRound(gameState.p1TurnChoice, hand);
                    gameState.p1TurnChoice = null;
                    gameState.currentPlayer = 'p1';
                }
            }
            updateUI();
        }

        function playRound(hand1, hand2) {
            if (gameState.isOver) return;
            gameState.currentRound++;
            gameState.handsCount.p1[hand1]++;
            gameState.handsCount.p2[hand2]++;
            const winner = determineWinner(hand1, hand2);
            let resultMessage = '', resultClass = '';
            if (winner === 'p1') { gameState.scores.p1++; resultMessage = `${DOMElements.playerName.textContent} の勝ち！`; resultClass = 'win'; }
            else if (winner === 'p2') { gameState.scores.p2++; resultMessage = `${DOMElements.aiName.textContent} の勝ち！`; resultClass = 'lose'; }
            else { gameState.scores.draw++; resultMessage = 'あいこ！'; resultClass = 'draw'; }
            gameState.history.p1_scores.push(gameState.scores.p1);
            gameState.history.p2_scores.push(gameState.scores.p2);
            gameState.history.draw_scores.push(gameState.scores.draw);
            gameState.history.rounds.push(gameState.currentRound);
            updateHandDisplays(hand1, hand2);
            setResultMessage(resultMessage, resultClass);
            if (gameState.settings.dataAnalysisEnabled) updateAllCharts();
            updateUI();
            checkGameEnd();
            if (!gameState.isOver && !gameState.isPaused) {
                const delay = (gameState.mode === 'ai-vs-ai') ? Math.max(50, 1000 / DOMElements.aiSpeedSlider.value) : 2000;
                roundResetTimeoutId = setTimeout(() => { if (gameState.isOver || gameState.isPaused) return; resetHandDisplays(); setResultMessage(getWaitingMessage()); updateUI(); }, delay);
            }
        }
        
        function determineWinner(hand1, hand2) { if (hand1 === hand2) return 'draw'; return WIN_CONDITIONS[hand1] === hand2 ? 'p1' : 'p2'; }
        function getAiHand(history) { if (Math.random() < 0.2 || history.length < 5) return HANDS[Math.floor(Math.random() * 3)]; const winningMove = Object.keys(WIN_CONDITIONS).find(key => WIN_CONDITIONS[key] === history[history.length - 1]); return winningMove || HANDS[Math.floor(Math.random() * 3)]; }

        function checkGameEnd() {
            if (gameState.gameLength !== Infinity && gameState.currentRound >= gameState.gameLength) {
                gameState.isOver = true;
                gameState.isPaused = true;
                let finalMessage = '勝負終了！ ';
                if (gameState.scores.p1 > gameState.scores.p2) finalMessage += `${DOMElements.playerName.textContent} の完全勝利！`;
                else if (gameState.scores.p2 > gameState.scores.p1) finalMessage += `${DOMElements.aiName.textContent} の完全勝利！`;
                else finalMessage += '引き分けです！';
                setResultMessage(finalMessage, 'draw');
                showNotification(finalMessage, 3000);
            }
            updateUI();
        }

        function startAiVsAi() { DOMElements.aiSpeedSlider.disabled = true; aiVsAiIntervalId = setInterval(runAiVsAiRound, 1000 / DOMElements.aiSpeedSlider.value); }
        function stopAiVsAi() { DOMElements.aiSpeedSlider.disabled = false; clearInterval(aiVsAiIntervalId); }
        function runAiVsAiRound() { if (gameState.isPaused || gameState.isOver) { stopAiVsAi(); return; } const hand1 = getAiHand(gameState.history.p2), hand2 = getAiHand(gameState.history.p1); gameState.history.p1.push(hand1); gameState.history.p2.push(hand2); if (gameState.history.p1.length > 200) gameState.history.p1.shift(); if (gameState.history.p2.length > 200) gameState.history.p2.shift(); playRound(hand1, hand2); }
        function updateSpeedDisplay(value) { DOMElements.aiSpeedDisplay.textContent = value; if (!gameState.isPaused) { stopAiVsAi(); startAiVsAi(); } }
        
        function updateUI() {
            const lengthDisplay = gameState.gameLength === Infinity ? '∞' : gameState.gameLength;
            DOMElements.roundInfo.textContent = `Round: ${gameState.currentRound} / ${lengthDisplay}`;
            DOMElements.playerScoreSpan.textContent = gameState.scores.p1;
            DOMElements.aiScoreSpan.textContent = gameState.scores.p2;
            DOMElements.drawScoreSpan.textContent = gameState.scores.draw;
            const p1ScoreEl = DOMElements.playerScoreSpan.parentElement;
            const p2ScoreEl = DOMElements.aiScoreSpan.parentElement;
            p1ScoreEl.classList.toggle('leading', gameState.scores.p1 > gameState.scores.p2);
            p2ScoreEl.classList.toggle('leading', gameState.scores.p2 > gameState.scores.p1);
            DOMElements.p1Rock.textContent = gameState.handsCount.p1.rock;
            DOMElements.p1Paper.textContent = gameState.handsCount.p1.paper;
            DOMElements.p1Scissors.textContent = gameState.handsCount.p1.scissors;
            DOMElements.p2Rock.textContent = gameState.handsCount.p2.rock;
            DOMElements.p2Paper.textContent = gameState.handsCount.p2.paper;
            DOMElements.p2Scissors.textContent = gameState.handsCount.p2.scissors;
            
            const isPlayerTurn = !gameState.isPaused && !gameState.isOver;
            DOMElements.playerChoiceButtons.forEach(b => b.disabled = !isPlayerTurn);
            
            const startBtn = DOMElements.startPauseButton, aiStartBtn = DOMElements.aiStartStopButton;
            const quitBtn = DOMElements.quitButton, aiQuitBtn = DOMElements.aiQuitButton;
            const newGameBtn = DOMElements.newGameButton, aiNewGameBtn = DOMElements.aiNewGameButton;
            
            [startBtn, aiStartBtn, quitBtn, aiQuitBtn, newGameBtn, aiNewGameBtn].forEach(b => b.style.display = 'none');

            const currentStartBtn = gameState.mode === 'ai-vs-ai' ? aiStartBtn : startBtn;
            const currentQuitBtn = gameState.mode === 'ai-vs-ai' ? aiQuitBtn : quitBtn;
            const currentNewGameBtn = gameState.mode === 'ai-vs-ai' ? aiNewGameBtn : newGameBtn;

            if (gameState.isOver) {
                currentNewGameBtn.style.display = 'inline-block';
            } else {
                currentStartBtn.style.display = 'inline-block';
                if (!gameState.isPaused) currentQuitBtn.style.display = 'inline-block';
                
                if (gameState.isPaused) {
                    currentStartBtn.textContent = 'スタート';
                    currentStartBtn.classList.remove('warning');
                } else {
                    currentStartBtn.textContent = '一時停止';
                    currentStartBtn.classList.add('warning');
                }
            }
            DOMElements.turnIndicator.style.display = gameState.mode === 'player-vs-player' ? 'block' : 'none';
            if (gameState.mode === 'player-vs-player') DOMElements.turnIndicator.textContent = isPlayerTurn ? `${gameState.currentPlayer === 'p1' ? DOMElements.playerName.textContent : DOMElements.aiName.textContent} の番です` : '';
        }

        function updateHandDisplays(hand1, hand2) {
            [DOMElements.playerHand, DOMElements.aiHand].forEach(el => el.classList.remove('pop-in'));
            void DOMElements.playerHand.offsetWidth;
            DOMElements.playerHand.innerHTML = HAND_EMOJIS[hand1];
            DOMElements.aiHand.innerHTML = HAND_EMOJIS[hand2];
            if (gameState.settings.popupsEnabled) {
                DOMElements.playerHand.classList.add('pop-in');
                DOMElements.aiHand.classList.add('pop-in');
            }
        }

        function resetHandDisplays() { clearTimeout(roundResetTimeoutId); [DOMElements.playerHand, DOMElements.aiHand].forEach(el => { el.classList.remove('pop-in'); el.innerHTML = '?'; }); }
        function setResultMessage(message, type = '') { DOMElements.resultDisplay.textContent = message; DOMElements.resultDisplay.className = 'result-display'; if (type) DOMElements.resultDisplay.classList.add(`result-${type}`); }
        function getWaitingMessage() { if (gameState.isOver) return DOMElements.resultDisplay.textContent; if (gameState.isPaused && gameState.currentRound === 0) return '「スタート」を押して開始'; if (gameState.isPaused) return '一時停止中...'; if (gameState.mode === 'ai-vs-ai') return '対戦中...'; let who = gameState.mode === 'player-vs-player' ? (gameState.currentPlayer === 'p1' ? DOMElements.playerName.textContent : DOMElements.aiName.textContent) : 'あなた'; return `${who}の手を選択してください`; }
        
        function resetGame(length = 0) {
            gameState = {
                mode: gameState.mode || '', gameLength: length, setupComplete: false, currentRound: 0,
                scores: { p1: 0, p2: 0, draw: 0 },
                handsCount: { p1: { rock: 0, paper: 0, scissors: 0 }, p2: { rock: 0, paper: 0, scissors: 0 } },
                history: { p1: [], p2: [], rounds: [0], p1_scores: [0], p2_scores: [0], draw_scores: [0] },
                isPaused: true, isOver: false,
                p1TurnChoice: null, currentPlayer: 'p1',
                settings: gameState.settings || { popupsEnabled: true, dataAnalysisEnabled: true }
            };
            clearTimeout(roundResetTimeoutId); clearInterval(aiVsAiIntervalId);
            DOMElements.popupsEnabledSwitch.checked = gameState.settings.popupsEnabled;
            DOMElements.dataAnalysisEnabledSwitch.checked = gameState.settings.dataAnalysisEnabled;
            DOMElements.dataPanel.style.display = gameState.settings.dataAnalysisEnabled ? 'flex' : 'none';
            DOMElements.gameContentGrid.classList.toggle('show-data-panel', gameState.settings.dataAnalysisEnabled);
            DOMElements.modeSelectionContainer.style.display = 'block';
            DOMElements.gameLengthContainer.style.display = 'none';
            resetHandDisplays();
            setResultMessage('「スタート」を押して開始');
            updateUI();
        }
        
        function getChartOptions(isDarkMode) { return { chart: { fontFamily: 'Roboto, sans-serif', foreColor: isDarkMode ? '#e0e0e0' : '#2c3e50', toolbar: { show: false }, zoom: { enabled: false }, animations: { enabled: true, easing: 'linear', dynamicAnimation: { speed: 500 } } }, xaxis: { labels: { style: { colors: isDarkMode ? '#e0e0e0' : '#2c3e50', fontFamily: 'Roboto, sans-serif' } }, axisBorder: { color: isDarkMode ? '#3a3a5e' : '#e3e8ee' }, axisTicks: { color: isDarkMode ? '#3a3a5e' : '#e3e8ee' } }, yaxis: { labels: { style: { colors: isDarkMode ? '#e0e0e0' : '#2c3e50', fontFamily: 'Roboto, sans-serif' }, formatter: (val) => Math.round(val) } }, grid: { borderColor: isDarkMode ? '#3a3a5e' : '#e3e8ee' }, legend: { labels: { colors: isDarkMode ? '#e0e0e0' : '#2c3e50', useSeriesColors: false }, markers: { radius: 4 } }, tooltip: { theme: isDarkMode ? 'dark' : 'light' } }; }
        
        // ▼▼▼ 変更点2: グラフの初期化処理に高さ(height)指定を追加しました ▼▼▼
        function initializeCharts() {
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const commonOptions = getChartOptions(isDarkMode);
            const colors = ['--accent1-color', '--accent2-color', '--accent3-color'].map(c => getComputedStyle(document.documentElement).getPropertyValue(c).trim());
            
            if (resultsChart) resultsChart.destroy();
            resultsChart = new ApexCharts(document.querySelector("#resultsChart"), { 
                ...commonOptions, 
                series: [], 
                colors: colors, 
                // heightプロパティを追加してお好みの高さに設定します (例: 500px)
                chart: { ...commonOptions.chart, id: 'resultsChart', type: 'line', height: 500 }, 
                stroke: { curve: 'straight', width: 2 }, 
                xaxis: { ...commonOptions.xaxis, type: 'numeric', title: { text: 'ラウンド数' }, min: 0, max: 1 },
                yaxis: { ...commonOptions.yaxis, title: { text: '累計スコア' }, min: 0 }, 
                title: { text: '勝負の推移', align: 'left' } 
            });
            
            if (handsChart) handsChart.destroy();
            handsChart = new ApexCharts(document.querySelector("#handsChart"), { 
                ...commonOptions, 
                series: [], 
                colors: colors.slice(0, 2), 
                // こちらのグラフにもheightプロパティを追加します (例: 450px)
                chart: { ...commonOptions.chart, id: 'handsChart', type: 'bar', height: 450 }, 
                plotOptions: { bar: { horizontal: false, columnWidth: '55%' } }, 
                xaxis: { ...commonOptions.xaxis, categories: ['✊', '✋', '✌️'] }, 
                yaxis: { ...commonOptions.yaxis, title: { text: '選択回数' } }, 
                title: { text: '各手の合計選択回数', align: 'left' }, 
                dataLabels: { enabled: false } 
            });

            Promise.all([resultsChart.render(), handsChart.render()]).then(() => {
                updateAllCharts();
            });
        }
        
        function updateAllCharts() {
            if (!resultsChart || !handsChart) return;

            resultsChart.updateSeries([ { name: DOMElements.p1HandsTitle.textContent, data: gameState.history.rounds.map((r, i) => [r, gameState.history.p1_scores[i]]) }, { name: DOMElements.p2HandsTitle.textContent, data: gameState.history.rounds.map((r, i) => [r, gameState.history.p2_scores[i]]) }, { name: 'あいこ', data: gameState.history.rounds.map((r, i) => [r, gameState.history.draw_scores[i]]) } ], gameState.mode !== 'ai-vs-ai');
            handsChart.updateSeries([ { name: DOMElements.p1HandsTitle.textContent, data: Object.values(gameState.handsCount.p1) }, { name: DOMElements.p2HandsTitle.textContent, data: Object.values(gameState.handsCount.p2) } ]);
            
            if (resultsChart) {
                const currentRound = gameState.currentRound;
                let xAxisMin, xAxisMax;
                if (currentRound > 200) {
                    xAxisMin = currentRound - 200;
                    xAxisMax = currentRound;
                } else {
                    xAxisMin = 0;
                    xAxisMax = (currentRound === 0) ? 1 : currentRound;
                }
                
                resultsChart.updateOptions({
                    xaxis: {
                        min: xAxisMin,
                        max: xAxisMax
                    }
                });
            }
        }
        
        function updateAllChartsTheme() { if (gameState.settings.dataAnalysisEnabled) { const opts = getChartOptions(window.matchMedia('(prefers-color-scheme: dark)').matches); if (resultsChart) resultsChart.updateOptions(opts); if (handsChart) handsChart.updateOptions(opts); } }
        function showNotification(message, duration = 3000) { clearTimeout(notificationTimeoutId); DOMElements.notificationMessage.textContent = message; DOMElements.notificationArea.classList.add('show'); notificationTimeoutId = setTimeout(() => DOMElements.notificationArea.classList.remove('show'), duration); }
        
        document.addEventListener('DOMContentLoaded', () => { resetGame(); initializeEventListeners(); showTab('setup'); });
    </script>
</body>
</html>
